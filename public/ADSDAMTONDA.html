<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Best Life Campaigns • ads_damtonda Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              green: '#16a34a',
              greenDark: '#0f7a37',
              gold: '#C6A044',
              cream: '#f6fbf7'
            }
          },
          boxShadow: { soft: '0 10px 25px rgba(0,0,0,0.07)' }
        }
      }
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(8px); }
    .gradient-hero { background: radial-gradient(1200px 600px at 20% -10%, rgba(22,163,74,0.07), transparent), radial-gradient(900px 500px at 100% 0%, rgba(198,160,68,0.08), transparent); }
    .logo-wordmark { line-height: 1; display: flex; flex-direction: column; gap: 0.25rem; }
    .logo-wordmark__title {
      font-weight: 800;
      font-size: 1.5rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: linear-gradient(90deg, #4a2c1b 0%, #d7b78a 50%, #f7ead3 100%);
      -webkit-background-clip: text;
      color: transparent;
      display: inline-block;
    }
    @media (min-width: 640px){
      .logo-wordmark__title { font-size: 1.75rem; }
    }
    .logo-wordmark__subtitle {
      font-size: 0.8rem;
      letter-spacing: 0.04em;
      color: #0f172a;
      font-weight: 500;
    }
    .checkbox-group {
      border-radius: 0.75rem;
      border: 1px solid rgba(16, 185, 129, 0.2);
      background-color: rgba(236, 253, 245, 0.4);
      padding: 0.75rem;
      max-height: 11rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .checkbox-group label {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.85rem;
      color: rgba(6, 95, 70, 0.85);
    }
    .checkbox-group input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: #16a34a;
    }
    .checkbox-group__empty {
      font-size: 0.75rem;
      color: rgba(6, 78, 59, 0.65);
    }
  </style>
</head>
<body class="bg-brand-cream min-h-screen gradient-hero">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 glass border-b border-emerald-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="logo-wordmark">
          <span class="logo-wordmark__title">BEST LIFE</span>
          <span class="logo-wordmark__subtitle">For Nature Herbs</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-brand-green text-white font-medium hover:bg-brand-greenDark transition shadow-soft">Refresh</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Filters Card -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5 sm:p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="filter" class="w-5 h-5 text-brand-gold"></svg>
        <h2 class="text-lg font-semibold text-emerald-900">Filters</h2>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Campaigns</label>
          <div id="f-campaignid" class="checkbox-group" role="group" aria-label="Campaign filters"></div>
        </div>
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Ad Sets</label>
          <div id="f-adsetid" class="checkbox-group" role="group" aria-label="Ad set filters"></div>
        </div>
        <div class="sm:col-span-2 lg:col-span-2 space-y-3">
          <div>
            <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Time window</label>
            <select id="f-time-preset" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none">
              <option value="">Any time</option>
              <option value="last_hour">Last hour</option>
              <option value="last_6_hours">Last 6 hours</option>
              <option value="last_24_hours">Last 24 hours</option>
              <option value="last_3_days">Last 3 days</option>
              <option value="last_7_days">Last 7 days</option>
              <option value="last_30_days">Last 30 days</option>
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="custom">Custom range</option>
            </select>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <label class="block">
              <span class="block text-[11px] font-semibold text-emerald-900/70 mb-1">Start</span>
              <input id="f-time-start" type="datetime-local" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none" />
            </label>
            <label class="block">
              <span class="block text-[11px] font-semibold text-emerald-900/70 mb-1">End</span>
              <input id="f-time-end" type="datetime-local" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none" />
            </label>
          </div>
          <p class="text-[11px] text-emerald-800/70">Quick ranges apply instantly. Custom start/end values override the preset when provided. Times are interpreted in your local timezone.</p>
        </div>
        <div class="sm:col-span-2">
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Conversion status</label>
          <select id="f-ordered" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none">
            <option value="">Any</option>
            <option value="true">Ordered only</option>
            <option value="false">Not ordered</option>
          </select>
        </div>
        <div class="flex items-end gap-3">
          <button id="applyBtn" class="flex-1 px-4 py-2 rounded-xl bg-brand-gold text-white font-semibold shadow-soft hover:opacity-90">Apply</button>
          <button id="clearBtn" class="px-4 py-2 rounded-xl border border-emerald-200 text-emerald-900 font-medium hover:bg-emerald-50">Clear</button>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section id="kpis" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></section>

    <!-- Charts -->
    <section class="grid xl:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="bar-chart-3" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Messages &amp; Orders by Campaign</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="campaignChart" height="280"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="pie-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Ordered vs Not</h3>
          </div>
        </div>
        <canvas id="orderedChart" height="280"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="line-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Messages by Ad Set</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="adsetChart" height="280"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="percent" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Orders per 100 Messages</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Min. 5 messages</span>
        </div>
        <canvas id="ratioChart" height="280"></canvas>
      </div>
    </section>

    <!-- Cards List -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="list" class="w-5 h-5 text-brand-gold"></svg>
        <h3 class="font-semibold text-emerald-900">Latest Records</h3>
      </div>
      <div id="cards" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      <div id="loadMoreWrap" class="mt-6 flex justify-center">
        <button id="loadMoreBtn" class="px-5 py-2 rounded-xl bg-emerald-100 text-emerald-900 font-medium hover:bg-emerald-200 hidden">Load more</button>
      </div>
    </section>
  </main>

  <!-- Supabase JS v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://whmbrguzumyatnslzfsq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobWJyZ3V6dW15YXRuc2x6ZnNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNTE2ODksImV4cCI6MjA2NDkyNzY4OX0.xcSogaAHv8uQzhFgEDZ1niFx8lirLiBRvkPpMF174YM';
    const TABLE = 'ads_damtonda';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const $ = (s, p=document) => p.querySelector(s);

    // UI elements
    const refreshBtn = $('#refreshBtn');
    const applyBtn   = $('#applyBtn');
    const clearBtn   = $('#clearBtn');
    const loadMoreBtn= $('#loadMoreBtn');
    const cardsWrap  = $('#cards');
    const kpisWrap   = $('#kpis');

    const fCampaign  = $('#f-campaignid');
    const fAdset     = $('#f-adsetid');
    const fOrdered   = $('#f-ordered');
    const fTimePreset= $('#f-time-preset');
    const fTimeStart = $('#f-time-start');
    const fTimeEnd   = $('#f-time-end');

    // Charts
    let campaignChart, orderedChart, adsetChart, ratioChart;

    // State
    let paginatedRows = [];
    let allRows = [];
    const PAGE_SIZE = 36;
    let pageIndex = 0;

    const CAMPAIGN_DIRECTORY_URL = 'https://primary-production-9e01d.up.railway.app/webhook/88011745-0650-4fdc-9caa-628ed08eab95';
    const MIN_MESSAGES_FOR_RATIO = 5;
    const chartColors = {
      messages: '#16a34a',
      orders: '#C6A044',
      ratio: '#0f7a37',
      notOrdered: '#d1fae5'
    };

    const campaignDirectory = new Map();
    let campaignDirectoryPromise = null;

    // Icons
    lucide.createIcons();

    // ---- helpers ----
    const isTrue = (val) => (val === true || val === 1 || (typeof val === 'string' && ['true','t','1','yes','y'].includes(val.toLowerCase())));

    const escapeHtml = (value) =>
      String(value ?? '').replace(/[&<>"']/g, (ch) => {
        switch (ch) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          default: return '&#39;';
        }
      });

    const getSelectedStrings = (element) => {
      if (!element) return [];
      if (element.tagName === 'SELECT') {
        return Array.from(element.selectedOptions ?? []).map(opt => opt.value).filter(Boolean);
      }
      return Array.from(element.querySelectorAll('input[type="checkbox"]:checked')).map(input => input.value).filter(Boolean);
    };

    function formatCampaignLabel(id){
      if (id === null || id === undefined || id === '') return '—';
      const key = String(id);
      const name = campaignDirectory.get(key);
      if (name && String(name).trim()){
        return `${String(name).trim()} (${key})`;
      }
      return `ID ${key}`;
    }

    function computeCampaignStats(rows){
      const stats = new Map();
      for (const row of rows){
        const rawId = row.campaignid;
        if (rawId === null || rawId === undefined || rawId === '') continue;
        const id = String(rawId);
        if (!stats.has(id)){
          stats.set(id, { id, count: 0, orders: 0 });
        }
        const entry = stats.get(id);
        entry.count += 1;
        if (isTrue(row.ordered)) entry.orders += 1;
      }
      return stats;
    }

    const TIMESTAMP_KEYS = ['time', 'TIME', 'timestamp', 'Timestamp', 'created_at', 'createdAt', 'created_time', 'createdTime', 'inserted_at', 'insertedAt', 'updated_at', 'updatedAt'];

    function parseTimestamp(value){
      if (!value && value !== 0) return null;
      if (value instanceof Date) {
        return isNaN(value.getTime()) ? null : value;
      }
      if (typeof value === 'number') {
        const date = new Date(value);
        return isNaN(date.getTime()) ? null : date;
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) return null;
        const normalised = trimmed.includes('T') ? trimmed : trimmed.replace(/\s+/, 'T');
        const date = new Date(normalised);
        if (!isNaN(date.getTime())) return date;
        const fallback = new Date(Date.parse(trimmed.replace(/\s+/, 'T')));
        return isNaN(fallback.getTime()) ? null : fallback;
      }
      return null;
    }

    function getRowTimestamp(row){
      if (!row || typeof row !== 'object') return null;
      for (const key of TIMESTAMP_KEYS){
        if (key in row){
          const parsed = parseTimestamp(row[key]);
          if (parsed) return parsed;
        }
      }
      return null;
    }

    function parseDateInput(value, { isEnd = false } = {}){
      if (!value) return null;
      const date = new Date(value);
      if (isNaN(date.getTime())) return null;
      if (isEnd && value.length <= 16){
        date.setSeconds(59, 999);
      }
      return date;
    }

    function computePresetRange(preset){
      if (!preset) return { start: null, end: null };
      const now = new Date();
      const hour = 60 * 60 * 1000;
      switch (preset){
        case 'last_hour':
          return { start: new Date(now.getTime() - hour), end: now };
        case 'last_6_hours':
          return { start: new Date(now.getTime() - 6 * hour), end: now };
        case 'last_24_hours':
          return { start: new Date(now.getTime() - 24 * hour), end: now };
        case 'last_3_days':
          return { start: new Date(now.getTime() - 3 * 24 * hour), end: now };
        case 'last_7_days':
          return { start: new Date(now.getTime() - 7 * 24 * hour), end: now };
        case 'last_30_days':
          return { start: new Date(now.getTime() - 30 * 24 * hour), end: now };
        case 'today': {
          const startOfDay = new Date(now);
          startOfDay.setHours(0, 0, 0, 0);
          const endOfDay = new Date(now);
          endOfDay.setHours(23, 59, 59, 999);
          return { start: startOfDay, end: endOfDay };
        }
        case 'yesterday': {
          const startOfDay = new Date(now);
          startOfDay.setDate(now.getDate() - 1);
          startOfDay.setHours(0, 0, 0, 0);
          const endOfDay = new Date(startOfDay);
          endOfDay.setHours(23, 59, 59, 999);
          return { start: startOfDay, end: endOfDay };
        }
        case 'custom':
        default:
          return { start: null, end: null };
      }
    }

    function resolveTimeRange(){
      const preset = fTimePreset ? fTimePreset.value : '';
      const presetRange = computePresetRange(preset);
      let { start, end } = presetRange;
      const customStart = parseDateInput(fTimeStart ? fTimeStart.value : '');
      const customEnd = parseDateInput(fTimeEnd ? fTimeEnd.value : '', { isEnd: true });
      if (customStart) start = customStart;
      if (customEnd) end = customEnd;
      if (start && end && start > end){
        return { start: end, end: start };
      }
      return { start, end };
    }

    function applyFilters(rows){
      const selectedCampaigns = new Set(getSelectedStrings(fCampaign));
      const selectedAdsets = new Set(getSelectedStrings(fAdset));
      const orderedFilter = fOrdered.value;
      const { start: startTime, end: endTime } = resolveTimeRange();

      return rows.filter((row) => {
        const campaignId = row.campaignid !== null && row.campaignid !== undefined ? String(row.campaignid) : null;
        if (selectedCampaigns.size && (!campaignId || !selectedCampaigns.has(campaignId))) return false;

        const adsetId = row.adsetid !== null && row.adsetid !== undefined ? String(row.adsetid) : null;
        if (selectedAdsets.size && (!adsetId || !selectedAdsets.has(adsetId))) return false;

        if (orderedFilter === 'true' && !isTrue(row.ordered)) return false;
        if (orderedFilter === 'false' && isTrue(row.ordered)) return false;

        if (startTime || endTime){
          const timestamp = getRowTimestamp(row);
          if (!timestamp) return false;
          if (startTime && timestamp < startTime) return false;
          if (endTime && timestamp > endTime) return false;
        }

        return true;
      });
    }

    function kpiCard({ label, value, sub }){
      return `
        <div class="bg-white border border-emerald-100 rounded-2xl p-4 shadow-soft">
          <div class="text-xs font-semibold text-emerald-800/70">${escapeHtml(label)}</div>
          <div class="mt-1 text-2xl font-extrabold text-emerald-900">${escapeHtml(value)}</div>
          ${sub ? `<div class="text-xs text-emerald-800/60 mt-1">${escapeHtml(sub)}</div>` : ''}
        </div>
      `;
    }

    function renderKPIs(rows){
      const totalMessages = rows.length;
      const campaignStats = Array.from(computeCampaignStats(rows).values());
      const totalOrders = campaignStats.reduce((sum, item) => sum + item.orders, 0);
      const overallConversion = totalMessages ? (totalOrders / totalMessages) * 100 : 0;

      const topByMessages = campaignStats.length ? campaignStats.reduce((best, current) => (current.count > best.count ? current : best), campaignStats[0]) : null;
      const conversionCandidates = campaignStats.filter(item => item.count >= MIN_MESSAGES_FOR_RATIO);
      let bestConversion = null;
      for (const item of conversionCandidates){
        const ratio = item.orders / item.count;
        if (!bestConversion || ratio > bestConversion.ratio){
          bestConversion = { ...item, ratio };
        }
      }

      kpisWrap.innerHTML = [
        kpiCard({ label: 'Total Messages', value: totalMessages.toLocaleString(), sub: `${overallConversion.toFixed(1)}% conversion` }),
        kpiCard({ label: 'Total Orders', value: totalOrders.toLocaleString(), sub: totalMessages ? `${totalOrders} of ${totalMessages}` : 'No orders yet' }),
        kpiCard({ label: 'Top Campaign (Messages)', value: topByMessages ? formatCampaignLabel(topByMessages.id) : '—', sub: topByMessages ? `${topByMessages.count.toLocaleString()} messages` : 'No campaigns' }),
        kpiCard({ label: 'Best Conversion Rate', value: bestConversion ? `${(bestConversion.ratio * 100).toFixed(1)}%` : '—', sub: bestConversion ? `${bestConversion.orders} orders · ${formatCampaignLabel(bestConversion.id)}` : 'Need more data' })
      ].join('');
    }

    function topCounts(rows, key, topN = 15, labelFormatter = (value) => String(value ?? '—')){
      const counts = new Map();
      for (const row of rows){
        const raw = row[key];
        if (raw === null || raw === undefined || raw === '') continue;
        const id = String(raw);
        counts.set(id, (counts.get(id) || 0) + 1);
      }
      const sorted = Array.from(counts.entries()).sort((a, b) => b[1] - a[1]).slice(0, topN);
      return {
        labels: sorted.map(([value]) => labelFormatter(value)),
        ids: sorted.map(([value]) => value),
        counts: sorted.map(([, count]) => count)
      };
    }

    function ensureChart(ctx, type, data, options){
      if (ctx.__chart){ ctx.__chart.destroy(); }
      ctx.__chart = new Chart(ctx, { type, data, options });
      return ctx.__chart;
    }

    function renderCharts(rows){
      const allCampaignStats = Array.from(computeCampaignStats(rows).values());
      const campaignStats = [...allCampaignStats].sort((a, b) => b.count - a.count).slice(0, 15);
      const campaignLabels = campaignStats.map((item) => formatCampaignLabel(item.id));
      const campaignMessages = campaignStats.map((item) => item.count);
      const campaignOrders = campaignStats.map((item) => item.orders);
      const cctx = document.getElementById('campaignChart');
      ensureChart(cctx, 'bar', {
        labels: campaignLabels,
        datasets: [
          { label: 'Messages', data: campaignMessages, backgroundColor: chartColors.messages, borderRadius: 8 },
          { label: 'Orders', data: campaignOrders, backgroundColor: chartColors.orders, borderRadius: 8 }
        ]
      }, {
        responsive: true,
        indexAxis: 'y',
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (context) => {
                const value = context.raw;
                const label = context.dataset.label || '';
                return `${label}: ${value.toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          x: { beginAtZero: true },
          y: { ticks: { autoSkip: false } }
        }
      });

      const orderedCount = rows.filter(r => isTrue(r.ordered)).length;
      const notOrderedCount = rows.length - orderedCount;
      const octx = document.getElementById('orderedChart');
      ensureChart(octx, 'doughnut', {
        labels: ['Ordered', 'Not ordered'],
        datasets: [{ data: [orderedCount, notOrderedCount], backgroundColor: [chartColors.orders, chartColors.notOrdered] }]
      }, {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      });

      const adsetCounts = topCounts(rows, 'adsetid', 15, (value) => `Ad Set ${value}`);
      const actx = document.getElementById('adsetChart');
      ensureChart(actx, 'bar', {
        labels: adsetCounts.labels,
        datasets: [{ label: 'Messages', data: adsetCounts.counts, backgroundColor: chartColors.messages, borderRadius: 8 }]
      }, {
        responsive: true,
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true }, y: { ticks: { autoSkip: false } } }
      });

      const ratioCandidates = allCampaignStats.filter(item => item.count >= MIN_MESSAGES_FOR_RATIO).map((item) => ({
        id: item.id,
        ratio: item.count ? (item.orders / item.count) * 100 : 0,
        orders: item.orders,
        count: item.count
      })).sort((a, b) => b.ratio - a.ratio || b.count - a.count).slice(0, 15);
      const ratioCtx = document.getElementById('ratioChart');
      ensureChart(ratioCtx, 'bar', {
        labels: ratioCandidates.map((item) => formatCampaignLabel(item.id)),
        datasets: [{ label: 'Orders per 100 messages', data: ratioCandidates.map(item => Number(item.ratio.toFixed(2))), backgroundColor: chartColors.ratio, borderRadius: 8 }]
      }, {
        responsive: true,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => {
                const ratio = context.raw;
                const stat = ratioCandidates[context.dataIndex];
                return `Conversion: ${ratio.toFixed(1)}% (${stat.orders}/${stat.count})`;
              }
            }
          }
        },
        scales: { x: { beginAtZero: true, max: 100 }, y: { ticks: { autoSkip: false } } }
      });
    }

    function recordCard(record){
      const badge = (label) => `<span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-900">${escapeHtml(label)}</span>`;
      const hasOrdered = isTrue(record.ordered);
      const campaignText = record.campaignid !== null && record.campaignid !== undefined ? formatCampaignLabel(record.campaignid) : '—';
      const adsetText = record.adsetid !== null && record.adsetid !== undefined ? `Ad Set: ${record.adsetid}` : 'Ad Set: —';

      return `
        <div class="rounded-2xl border border-emerald-100 bg-white p-4 shadow-soft">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] uppercase tracking-wide text-emerald-800/60">ID #${escapeHtml(record.id)}</div>
              <div class="mt-1 text-lg font-semibold text-emerald-900">${escapeHtml(record.adid ? `Ad ${record.adid}` : 'Ad —')}</div>
            </div>
            <div class="h-9 w-9 rounded-xl flex items-center justify-center ${hasOrdered ? 'bg-brand-gold' : 'bg-emerald-100'}" title="Ordered">
              <svg data-lucide="${hasOrdered ? 'check' : 'circle'}" class="w-5 h-5 ${hasOrdered ? 'text-white' : 'text-emerald-700'}"></svg>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            ${badge('Campaign: ' + campaignText)}
            ${badge(adsetText)}
            ${record.psid != null ? badge('PSID: ' + record.psid) : ''}
          </div>
          ${hasOrdered ? `<div class="mt-3 text-sm text-emerald-900"><span class="font-semibold">Ordered:</span> TRUE</div>` : ''}
        </div>
      `;
    }

    function renderCards(rows){
      const start = pageIndex * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      if (!rows.length){
        cardsWrap.innerHTML = '<div class="md:col-span-2 xl:col-span-3 text-sm text-emerald-800/70 bg-emerald-50/60 border border-emerald-100 rounded-2xl p-4 text-center">No messages match your filters yet. Adjust the selections to explore more activity.</div>';
        loadMoreBtn.classList.add('hidden');
        lucide.createIcons();
        return;
      }
      const slice = rows.slice(start, end);
      const html = slice.map(recordCard).join('');
      if (pageIndex === 0){
        cardsWrap.innerHTML = html;
      } else {
        cardsWrap.insertAdjacentHTML('beforeend', html);
      }
      loadMoreBtn.classList.toggle('hidden', end >= rows.length);
      lucide.createIcons();
    }

    function renderCheckboxGroup(container, values, { labelGetter = (value) => value, emptyMessage = 'No options available' } = {}){
      if (!container) return;
      const previouslySelected = new Set(getSelectedStrings(container));
      container.innerHTML = '';
      if (!values.length){
        const empty = document.createElement('div');
        empty.className = 'checkbox-group__empty';
        empty.textContent = emptyMessage;
        container.appendChild(empty);
        return;
      }
      for (const rawValue of values){
        const value = String(rawValue);
        const label = labelGetter(rawValue);
        const option = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = value;
        input.checked = previouslySelected.has(value);
        const text = document.createElement('span');
        text.textContent = label;
        option.appendChild(input);
        option.appendChild(text);
        container.appendChild(option);
      }
    }

    function populateDropdowns(rows){
      const campaigns = Array.from(new Set(rows.map(r => r.campaignid).filter(v => v !== null && v !== undefined && v !== '')))
        .map((value) => String(value))
        .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

      renderCheckboxGroup(fCampaign, campaigns, {
        labelGetter: (campaignId) => formatCampaignLabel(campaignId),
        emptyMessage: 'No campaigns available'
      });

      const selectedCampaigns = new Set(getSelectedStrings(fCampaign));
      const effectiveCampaigns = selectedCampaigns.size ? selectedCampaigns : new Set(campaigns.map(String));

      const adsetPool = rows.filter(r => {
        const campaignId = r.campaignid !== null && r.campaignid !== undefined ? String(r.campaignid) : null;
        return !selectedCampaigns.size || (campaignId && effectiveCampaigns.has(campaignId));
      });
      const adsets = Array.from(new Set(adsetPool.map(r => r.adsetid).filter(v => v !== null && v !== undefined && v !== '')))
        .map((value) => String(value))
        .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

      renderCheckboxGroup(fAdset, adsets, {
        labelGetter: (value) => value,
        emptyMessage: selectedCampaigns.size ? 'No ad sets for selection' : 'No ad sets available'
      });
    }

    async function trySupabaseChunk(from, to){
      try {
        const { data, error } = await supabase.from(TABLE).select('*').order('id', { ascending: false }).range(from, to);
        if (error) throw error;
        return data;
      } catch (error){
        console.warn('[supabase-js] chunk err:', error?.message || error);
        return null;
      }
    }

    async function tryRestChunk(from, to){
      const params = new URLSearchParams({ select: '*', order: 'id.desc' });
      const url = `${SUPABASE_URL}/rest/v1/${TABLE}?` + params.toString();
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          Range: `${from}-${to}`,
          Accept: 'application/json'
        }
      });
      if (!res.ok) throw new Error(`REST ${res.status}`);
      return await res.json();
    }

    async function fetchAll(limit = 5000){
      const batch = 1000;
      let from = 0;
      let to = Math.min(batch - 1, limit - 1);
      const rows = [];
      let usedRest = false;

      while (from < limit){
        let chunk = await trySupabaseChunk(from, to);
        if (chunk === null){
          usedRest = true;
          chunk = await tryRestChunk(from, to);
        }
        rows.push(...chunk);
        if (chunk.length < (to - from + 1)) break;
        from += batch;
        to = Math.min(to + batch, limit - 1);
      }
      if (usedRest) console.info('Using REST fallback');
      return rows;
    }

    function parseCampaignLine(line){
      if (typeof line !== 'string') return null;
      const clean = line.replace(/\r/g, '').trim();
      const idx = clean.indexOf(' - ');
      if (idx === -1){
        const idOnly = clean.trim();
        return { id: idOnly, name: '' };
      }
      const id = clean.slice(0, idx).trim();
      const name = clean.slice(idx + 3).replace(/\s+/g, ' ').trim();
      return { id, name };
    }

    function normalizeCampaignDirectory(data){
      try {
        if (!data) return [];
        const root = Array.isArray(data) ? data[0] : data;
        if (!root) return [];
        const arr = root['all campaigns'] || root['all_campaigns'] || root['campaigns'] || [];
        if (!Array.isArray(arr)) return [];
        const unique = new Map();
        for (const item of arr){
          const parsed = parseCampaignLine(item);
          if (parsed && parsed.id){
            unique.set(parsed.id, parsed);
          }
        }
        return Array.from(unique.values());
      } catch (error){
        console.warn('Failed to normalise campaign directory', error);
        return [];
      }
    }

    async function ensureCampaignDirectory(){
      if (campaignDirectory.size) return campaignDirectory;
      if (campaignDirectoryPromise) return campaignDirectoryPromise;

      campaignDirectoryPromise = (async () => {
        try {
          const response = await fetch(CAMPAIGN_DIRECTORY_URL, { method: 'GET', cache: 'no-store' });
          const text = await response.text();
          let json;
          try { json = JSON.parse(text); } catch { json = null; }
          const parsed = normalizeCampaignDirectory(json ?? text);
          campaignDirectory.clear();
          for (const item of parsed){
            campaignDirectory.set(String(item.id), item.name || '');
          }
        } catch (error){
          console.warn('Failed to load campaign directory', error);
        } finally {
          campaignDirectoryPromise = null;
        }
        return campaignDirectory;
      })();

      return campaignDirectoryPromise;
    }

    async function run({ refresh = false } = {}){
      try {
        document.body.style.cursor = 'progress';
        await ensureCampaignDirectory();
        if (refresh || !allRows.length){
          allRows = await fetchAll(5000);
        }
        populateDropdowns(allRows);
        const filtered = applyFilters(allRows);
        renderKPIs(filtered);
        renderCharts(filtered);
        paginatedRows = filtered;
        pageIndex = 0;
        renderCards(paginatedRows);
      } catch (err){
        console.error(err);
        alert('Failed to fetch data. Check Supabase RLS and credentials.\n' + (err?.message || err));
      } finally {
        document.body.style.cursor = 'default';
      }
    }

    function clearMultiselect(element){
      if (!element) return;
      if (element.tagName === 'SELECT'){
        Array.from(element.options ?? []).forEach((option) => { option.selected = false; });
        return;
      }
      element.querySelectorAll('input[type="checkbox"]').forEach((input) => {
        input.checked = false;
      });
    }

    // Events
    refreshBtn.addEventListener('click', () => run({ refresh: true }));
    applyBtn.addEventListener('click', () => run());
    clearBtn.addEventListener('click', () => {
      clearMultiselect(fCampaign);
      clearMultiselect(fAdset);
      fOrdered.value = '';
      if (fTimePreset) fTimePreset.value = '';
      if (fTimeStart) fTimeStart.value = '';
      if (fTimeEnd) fTimeEnd.value = '';
      run();
    });
    [fCampaign, fAdset, fOrdered, fTimePreset, fTimeStart, fTimeEnd]
      .filter(Boolean)
      .forEach((input) => input.addEventListener('change', () => run()));
    [fTimeStart, fTimeEnd]
      .filter(Boolean)
      .forEach((input) => input.addEventListener('input', () => run()));
    loadMoreBtn.addEventListener('click', () => {
      pageIndex += 1;
      renderCards(paginatedRows);
    });

    // Boot
    run();
  </script>
</body>
</html>
