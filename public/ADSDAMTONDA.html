<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Best Life Campaigns • ads_damtonda Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              green: '#16a34a',
              greenDark: '#0f7a37',
              gold: '#C6A044',
              cream: '#f6fbf7'
            }
          },
          boxShadow: { soft: '0 10px 25px rgba(0,0,0,0.07)' }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(8px); }
    .gradient-hero { background: radial-gradient(1200px 600px at 20% -10%, rgba(22,163,74,0.07), transparent), radial-gradient(900px 500px at 100% 0%, rgba(198,160,68,0.08), transparent); }
  </style>
</head>
<body class="bg-brand-cream min-h-screen gradient-hero">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 glass border-b border-emerald-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-brand-green flex items-center justify-center shadow-soft">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" class="h-6 w-6">
            <path d="M12 4v16M4 12h16"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-brand-green">Best Life Campaigns</h1>
          <p class="text-xs sm:text-sm text-emerald-800/60">ads_damtonda — Health-inspired analytics</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-brand-green text-white font-medium hover:bg-brand-greenDark transition shadow-soft">Refresh</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Filters Card -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5 sm:p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="filter" class="w-5 h-5 text-brand-gold"></svg>
        <h2 class="text-lg font-semibold text-emerald-900">Filters</h2>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Campaigns</label>
          <div id="campaignFilter" class="relative" data-ms-root="campaigns">
            <button type="button" class="w-full flex items-center justify-between gap-2 rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 text-sm font-medium text-emerald-900 focus:outline-none focus:ring-2 focus:ring-brand-gold/40" data-ms-trigger aria-haspopup="listbox" aria-expanded="false">
              <span data-ms-label>All campaigns</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6"/></svg>
            </button>
            <div data-ms-dropdown class="absolute left-0 right-0 top-full z-40 mt-2 hidden rounded-2xl border border-emerald-100 bg-white shadow-soft">
              <div class="border-b border-emerald-100 px-3 py-2">
                <input type="search" data-ms-search class="w-full rounded-lg border border-emerald-100 bg-emerald-50/40 px-3 py-2 text-sm text-emerald-900 focus:outline-none focus:ring-2 focus:ring-brand-gold/40" placeholder="Search campaigns" autocomplete="off">
              </div>
              <div data-ms-options class="max-h-60 overflow-y-auto p-2 space-y-1"></div>
              <div data-ms-empty class="hidden px-3 py-6 text-center text-sm text-emerald-700/70">No campaigns found</div>
              <div class="flex items-center justify-between gap-2 border-t border-emerald-100 px-3 py-2">
                <button type="button" data-ms-clear class="text-xs font-semibold text-emerald-700 hover:text-brand-green">Clear</button>
                <button type="button" data-ms-close class="text-xs font-semibold text-brand-green hover:text-brand-greenDark">Done</button>
              </div>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Ad Sets</label>
          <div id="adsetFilter" class="relative" data-ms-root="adsets">
            <button type="button" class="w-full flex items-center justify-between gap-2 rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 text-sm font-medium text-emerald-900 focus:outline-none focus:ring-2 focus:ring-brand-gold/40" data-ms-trigger aria-haspopup="listbox" aria-expanded="false">
              <span data-ms-label>All ad sets</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6"/></svg>
            </button>
            <div data-ms-dropdown class="absolute left-0 right-0 top-full z-40 mt-2 hidden rounded-2xl border border-emerald-100 bg-white shadow-soft">
              <div class="border-b border-emerald-100 px-3 py-2">
                <input type="search" data-ms-search class="w-full rounded-lg border border-emerald-100 bg-emerald-50/40 px-3 py-2 text-sm text-emerald-900 focus:outline-none focus:ring-2 focus:ring-brand-gold/40" placeholder="Search ad sets" autocomplete="off">
              </div>
              <div data-ms-options class="max-h-60 overflow-y-auto p-2 space-y-1"></div>
              <div data-ms-empty class="hidden px-3 py-6 text-center text-sm text-emerald-700/70">No ad sets found</div>
              <div class="flex items-center justify-between gap-2 border-t border-emerald-100 px-3 py-2">
                <button type="button" data-ms-clear class="text-xs font-semibold text-emerald-700 hover:text-brand-green">Clear</button>
                <button type="button" data-ms-close class="text-xs font-semibold text-brand-green hover:text-brand-greenDark">Done</button>
              </div>
            </div>
          </div>
        </div>
        <div class="sm:col-span-2">
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Ordered</label>
          <select id="f-ordered" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none">
            <option value="">Any</option>
            <option value="true">Ordered only</option>
          </select>
        </div>
        <div class="flex items-end gap-3">
          <button id="applyBtn" class="flex-1 px-4 py-2 rounded-xl bg-brand-gold text-white font-semibold shadow-soft hover:opacity-90">Apply</button>
          <button id="clearBtn" class="px-4 py-2 rounded-xl border border-emerald-200 text-emerald-900 font-medium hover:bg-emerald-50">Clear</button>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section id="kpis" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></section>

    <!-- Charts -->
    <section class="grid lg:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="bar-chart-3" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Messages &amp; Orders by Campaign</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="campaignChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="pie-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Ordered vs Not</h3>
          </div>
        </div>
        <canvas id="orderedChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="line-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Records by Ad Set ID</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="adsetChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="percent" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Conversion Rate by Campaign</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Best 10 (≥5 msgs)</span>
        </div>
        <canvas id="campaignRatioChart" height="240"></canvas>
      </div>
    </section>

    <!-- Cards List -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="list" class="w-5 h-5 text-brand-gold"></svg>
        <h3 class="font-semibold text-emerald-900">Latest Records</h3>
      </div>
      <div id="cards" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      <div id="loadMoreWrap" class="mt-6 flex justify-center">
        <button id="loadMoreBtn" class="px-5 py-2 rounded-xl bg-emerald-100 text-emerald-900 font-medium hover:bg-emerald-200 hidden">Load more</button>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-emerald-900/60">
    <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100">Made for Best Life — golden accents on white & green ✨</span>
  </footer>

  <!-- Supabase JS v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://whmbrguzumyatnslzfsq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobWJyZ3V6dW15YXRuc2x6ZnNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNTE2ODksImV4cCI6MjA2NDkyNzY4OX0.xcSogaAHv8uQzhFgEDZ1niFx8lirLiBRvkPpMF174YM';
    const TABLE = 'ads_damtonda';
    const CAMPAIGN_LIST_URL = 'https://primary-production-9e01d.up.railway.app/webhook/88011745-0650-4fdc-9caa-628ed08eab95';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const $ = (s, p=document) => p.querySelector(s);

    // UI elements
    const refreshBtn = $('#refreshBtn');
    const applyBtn   = $('#applyBtn');
    const clearBtn   = $('#clearBtn');
    const loadMoreBtn= $('#loadMoreBtn');
    const cardsWrap  = $('#cards');
    const kpisWrap   = $('#kpis');
    const orderedSelect = $('#f-ordered');
    const campaignFilterRoot = document.getElementById('campaignFilter');
    const adsetFilterRoot = document.getElementById('adsetFilter');

    const campaignFilter = createMultiSelect(campaignFilterRoot, {
      placeholder: 'All campaigns',
      onChange: () => {
        updateAdsetOptions();
        applyFiltersAndRender();
      }
    });

    const adsetFilter = createMultiSelect(adsetFilterRoot, {
      placeholder: 'All ad sets',
      onChange: () => applyFiltersAndRender()
    });

    // Charts
    let campaignChart, orderedChart, adsetChart, campaignRatioChart;

    // State
    let paginatedRows = [];
    let allRows = [];
    const PAGE_SIZE = 36;
    let pageIndex = 0;
    let campaignDirectory = new Map();
    let campaignDirectoryPromise = null;

    // Icons
    lucide.createIcons();

    // ---- helpers ----
    function escapeHtml(value){
      if (value === null || value === undefined) return '';
      return String(value).replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch] || ch));
    }

    const isTrue = (val) => (val === true || val === 1 || (typeof val === 'string' && ['true','t','1','yes','y'].includes(val.toLowerCase())));

    function parseCampaignLine(line){
      if (typeof line !== 'string') return null;
      const clean = line.replace(//g,'').trim();
      if (!clean) return null;
      const idx = clean.indexOf(' - ');
      if (idx === -1) return { id: clean, name: '' };
      const id = clean.slice(0, idx).trim();
      const name = clean.slice(idx + 3).replace(/\s+/g, ' ').trim();
      return { id, name };
    }

    function normalizeCampaignPayload(payload){
      try {
        const root = Array.isArray(payload) ? payload[0] : payload;
        if (!root) return [];
        const arr = root['all campaigns'] || root['all_campaigns'] || root['campaigns'] || [];
        if (!Array.isArray(arr)) return [];
        const map = new Map();
        for (const item of arr){
          const parsed = parseCampaignLine(item);
          if (parsed?.id && !map.has(parsed.id)){
            map.set(parsed.id, parsed);
          }
        }
        return Array.from(map.values());
      } catch (err){
        console.warn('Failed to normalise campaign payload', err);
        return [];
      }
    }

    async function fetchCampaignDirectory(){
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 60000);
      try {
        const res = await fetch(CAMPAIGN_LIST_URL, { mode: 'cors', credentials: 'omit', cache: 'no-store', signal: controller.signal });
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = text; }
        const campaigns = normalizeCampaignPayload(json);
        const map = new Map();
        for (const item of campaigns){
          const id = item.id?.toString();
          if (!id) continue;
          map.set(id, item.name || '');
        }
        return map;
      } catch (err){
        console.warn('Failed to fetch campaign directory', err);
        return new Map();
      } finally {
        clearTimeout(timeout);
      }
    }

    async function ensureCampaignDirectory(){
      if (campaignDirectory.size) return campaignDirectory;
      if (!campaignDirectoryPromise){
        campaignDirectoryPromise = fetchCampaignDirectory().then(map => {
          campaignDirectory = map;
          return map;
        }).catch(err => {
          console.warn('Campaign directory load error', err);
          return campaignDirectory;
        }).finally(() => {
          campaignDirectoryPromise = null;
        });
      }
      try {
        return await campaignDirectoryPromise;
      } catch {
        return campaignDirectory;
      }
    }

    function getCampaignName(id){
      if (id === null || id === undefined || id === '') return null;
      const key = String(id);
      return campaignDirectory.get(key) || null;
    }

    function formatCampaignLabel(id, { short=false } = {}){
      if (id === null || id === undefined || id === '') return '—';
      const name = getCampaignName(id);
      const base = name ? (short ? name : `${name} (#${id})`) : `Campaign ${id}`;
      return base;
    }

    function createMultiSelect(root, { placeholder='Select', onChange } = {}){
      if (!root) return {
        setOptions(){},
        getSelectedValues(){ return []; },
        setSelectedValues(){},
        clear(){ return false; },
        close(){},
        clearSilently(){},
      };

      const trigger = root.querySelector('[data-ms-trigger]');
      const dropdown = root.querySelector('[data-ms-dropdown]');
      const labelEl = root.querySelector('[data-ms-label]');
      const optionsWrap = root.querySelector('[data-ms-options]');
      const searchInput = root.querySelector('[data-ms-search]');
      const emptyState = root.querySelector('[data-ms-empty]');
      const clearBtn = root.querySelector('[data-ms-clear]');
      const closeBtn = root.querySelector('[data-ms-close]');

      let options = [];
      const selected = new Set();

      function getSelectedValues(){
        return Array.from(selected);
      }

      function updateLabel(){
        if (!labelEl) return;
        if (!selected.size){
          labelEl.textContent = placeholder;
          return;
        }
        const picked = options.filter(opt => selected.has(opt.value)).map(opt => opt.label);
        labelEl.textContent = picked.length <= 2 ? picked.join(', ') : `${picked.length} selected`;
      }

      function renderOptions(){
        if (!optionsWrap) return;
        if (!options.length){
          optionsWrap.innerHTML = '';
          if (emptyState) emptyState.classList.remove('hidden');
          return;
        }
        if (emptyState) emptyState.classList.add('hidden');
        const html = options.map(opt => {
          const checked = selected.has(opt.value) ? 'checked' : '';
          const badgeHtml = opt.badge ? `<span class="ml-3 inline-flex items-center rounded-full bg-brand-green/10 px-2 py-0.5 text-xs font-semibold text-brand-green/80">${escapeHtml(opt.badge)}</span>` : '';
          const descriptionHtml = opt.description ? `<div class="text-xs text-emerald-700/70">${escapeHtml(opt.description)}</div>` : '';
          return `
            <label class="flex cursor-pointer items-center gap-3 rounded-xl px-3 py-2 hover:bg-emerald-50" data-ms-option data-value="${escapeHtml(opt.value)}" data-search="${escapeHtml(opt.search)}">
              <input type="checkbox" class="h-4 w-4 rounded border-emerald-200 text-brand-green focus:ring-brand-gold/50" value="${escapeHtml(opt.value)}" ${checked}>
              <div class="flex-1">
                <div class="text-sm font-medium text-emerald-900">${escapeHtml(opt.label)}</div>
                ${descriptionHtml}
              </div>
              ${badgeHtml}
            </label>
          `;
        }).join('');
        optionsWrap.innerHTML = html;
      }

      function filterOptions(term){
        if (!optionsWrap) return;
        const query = term.trim().toLowerCase();
        let visible = 0;
        optionsWrap.querySelectorAll('[data-ms-option]').forEach(el => {
          const haystack = (el.dataset.search || '').toLowerCase();
          const match = !query || haystack.includes(query);
          el.classList.toggle('hidden', !match);
          if (match) visible += 1;
        });
        if (emptyState){
          emptyState.classList.toggle('hidden', visible > 0);
        }
      }

      function setOptions(newOptions){
        options = (newOptions || []).map(opt => ({
          value: String(opt.value),
          label: opt.label || String(opt.value),
          description: opt.description || '',
          badge: opt.badge || '',
          search: (opt.search || `${opt.label || opt.value} ${opt.description || ''} ${opt.badge || ''}`).toString()
        }));
        const allowed = new Set(options.map(opt => opt.value));
        let removed = false;
        Array.from(selected).forEach(value => {
          if (!allowed.has(value)){
            selected.delete(value);
            removed = true;
          }
        });
        renderOptions();
        updateLabel();
        if (searchInput) filterOptions(searchInput.value || '');
        if (removed && typeof onChange === 'function'){
          onChange(getSelectedValues());
        }
      }

      function setSelectedValues(values){
        selected.clear();
        (values || []).forEach(value => {
          const v = String(value);
          if (options.some(opt => opt.value === v)) selected.add(v);
        });
        renderOptions();
        updateLabel();
        if (searchInput) filterOptions(searchInput.value || '');
      }

      function clear({ silent=false } = {}){
        if (!selected.size) return false;
        selected.clear();
        renderOptions();
        updateLabel();
        if (searchInput) filterOptions(searchInput.value || '');
        if (!silent && typeof onChange === 'function'){
          onChange(getSelectedValues());
        }
        return true;
      }

      function closeDropdown(){
        if (dropdown) dropdown.classList.add('hidden');
        if (trigger) trigger.setAttribute('aria-expanded', 'false');
      }

      function openDropdown(){
        if (dropdown) dropdown.classList.remove('hidden');
        if (trigger) trigger.setAttribute('aria-expanded', 'true');
        if (searchInput){
          searchInput.value = '';
          filterOptions('');
          setTimeout(() => searchInput.focus(), 0);
        }
      }

      trigger?.addEventListener('click', (event) => {
        event.preventDefault();
        if (dropdown?.classList.contains('hidden')) openDropdown(); else closeDropdown();
      });

      closeBtn?.addEventListener('click', () => closeDropdown());

      clearBtn?.addEventListener('click', () => {
        const changed = clear();
        if (!changed) closeDropdown();
      });

      optionsWrap?.addEventListener('change', (event) => {
        const input = event.target;
        if (!(input instanceof HTMLInputElement) || input.type !== 'checkbox') return;
        const value = input.value;
        if (input.checked) selected.add(value); else selected.delete(value);
        updateLabel();
        if (typeof onChange === 'function') onChange(getSelectedValues());
      });

      searchInput?.addEventListener('input', (event) => {
        filterOptions(event.target.value || '');
      });

      document.addEventListener('click', (event) => {
        if (!root.contains(event.target)) closeDropdown();
      });

      root.addEventListener('keydown', (event) => {
        if (event.key === 'Escape'){
          closeDropdown();
          trigger?.focus();
        }
      });

      updateLabel();

      return {
        setOptions,
        getSelectedValues,
        setSelectedValues,
        clear,
        clearSilently: () => clear({ silent: true }),
        close: closeDropdown
      };
    }

    async function trySupabaseChunk(from, to){
      try {
        const { data, error } = await supabase.from(TABLE).select('*').order('id', { ascending: false }).range(from, to);
        if (error) throw error;
        return data;
      } catch (e){
        console.warn('[supabase-js] chunk err:', e?.message||e);
        return null;
      }
    }

    async function tryRestChunk(from, to){
      const params = new URLSearchParams({ select: '*', order: 'id.desc' });
      const url = `${SUPABASE_URL}/rest/v1/${TABLE}?${params.toString()}`;
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          Range: `${from}-${to}`,
          Accept: 'application/json'
        }
      });
      if (!res.ok) throw new Error(`REST ${res.status}`);
      return await res.json();
    }

    async function fetchAll(limit=5000){
      const batch = 1000;
      let from = 0, to = Math.min(batch-1, limit-1);
      const out = [];
      let usedRest = false;

      while (from < limit){
        let chunk = await trySupabaseChunk(from, to);
        if (chunk === null){ usedRest = true; chunk = await tryRestChunk(from, to); }
        out.push(...chunk);
        if (chunk.length < (to-from+1)) break;
        from += batch; to = Math.min(to + batch, limit-1);
      }
      if (usedRest) console.info('Using REST fallback');
      return out;
    }

    function buildKeyStats(rows, key){
      const stats = new Map();
      for (const row of rows){
        const value = row[key];
        if (value === null || value === undefined || value === '') continue;
        const idStr = String(value);
        let entry = stats.get(idStr);
        if (!entry){
          entry = { id: value, idStr, messages: 0, orders: 0 };
          stats.set(idStr, entry);
        }
        entry.messages += 1;
        if (isTrue(row.ordered)) entry.orders += 1;
      }
      return stats;
    }

    const buildCampaignStats = (rows) => buildKeyStats(rows, 'campaignid');
    const buildAdsetStats = (rows) => buildKeyStats(rows, 'adsetid');

    function createCampaignOptions(rows){
      const stats = buildCampaignStats(rows);
      return Array.from(stats.values())
        .sort((a,b) => b.messages - a.messages)
        .map(entry => {
          const name = getCampaignName(entry.id);
          const label = name || `Campaign ${entry.idStr}`;
          const descriptionParts = [`ID ${entry.idStr}`, `${entry.messages.toLocaleString()} msgs`];
          const badge = entry.orders ? `${entry.orders.toLocaleString()} orders` : (entry.messages ? `${((entry.orders/entry.messages)*100).toFixed(1)}% conv` : '');
          return {
            value: entry.idStr,
            label,
            description: descriptionParts.join(' • '),
            badge,
            search: `${label} ${descriptionParts.join(' ')} ${badge}`.trim()
          };
        });
    }

    function createAdsetOptions(rows){
      const stats = buildAdsetStats(rows);
      return Array.from(stats.values())
        .sort((a,b) => b.messages - a.messages)
        .map(entry => {
          const label = `Ad Set ${entry.idStr}`;
          const description = `${entry.messages.toLocaleString()} msgs`;
          const badge = entry.orders ? `${entry.orders.toLocaleString()} orders` : '';
          return {
            value: entry.idStr,
            label,
            description,
            badge,
            search: `${label} ${description} ${badge}`.trim()
          };
        });
    }

    function populateCampaignOptions(rows){
      campaignFilter.setOptions(createCampaignOptions(rows));
    }

    function updateAdsetOptions(){
      const selectedCampaigns = new Set(campaignFilter.getSelectedValues());
      const baseRows = selectedCampaigns.size ? allRows.filter(row => {
        const campaignId = row.campaignid !== null && row.campaignid !== undefined ? String(row.campaignid) : null;
        return campaignId && selectedCampaigns.has(campaignId);
      }) : allRows;
      adsetFilter.setOptions(createAdsetOptions(baseRows));
    }

    function kpiCard({label, value, sub}) {
      return `
        <div class="bg-white border border-emerald-100 rounded-2xl p-4 shadow-soft">
          <div class="text-xs font-semibold text-emerald-800/70">${label}</div>
          <div class="mt-1 text-2xl font-extrabold text-emerald-900">${value}</div>
          ${sub ? `<div class="text-xs text-emerald-800/60 mt-1">${sub}</div>` : ''}
        </div>
      `;
    }

    function renderKPIs(rows){
      const total = rows.length;
      const campaignStats = buildCampaignStats(rows);
      const statsArray = Array.from(campaignStats.values());
      const orderedCount = rows.filter(r => isTrue(r.ordered)).length;
      const orderedPct = total ? Math.round((orderedCount/total)*100) : 0;
      const topMessages = statsArray.length ? statsArray.reduce((best, current) => current.messages > best.messages ? current : best, statsArray[0]) : null;
      const topOrders = statsArray.length ? statsArray.reduce((best, current) => current.orders > best.orders ? current : best, statsArray[0]) : null;
      const uniqCampaigns = campaignStats.size;
      const avgPerCampaign = uniqCampaigns ? (total / uniqCampaigns).toFixed(1) : '0';
      const messagesPerOrder = orderedCount ? (total / orderedCount).toFixed(1) : null;

      kpisWrap.innerHTML = [
        kpiCard({
          label: 'Total Messages',
          value: total.toLocaleString(),
          sub: topMessages ? `Top: ${escapeHtml(formatCampaignLabel(topMessages.id, { short: true }))} • ${topMessages.messages.toLocaleString()} msgs` : 'Top: —'
        }),
        kpiCard({
          label: 'Total Orders',
          value: orderedCount.toLocaleString(),
          sub: (topOrders && topOrders.orders > 0) ? `Top: ${escapeHtml(formatCampaignLabel(topOrders.id, { short: true }))} • ${topOrders.orders.toLocaleString()} orders` : 'Top: —'
        }),
        kpiCard({
          label: 'Unique Campaigns',
          value: uniqCampaigns.toLocaleString(),
          sub: uniqCampaigns ? `Avg ${avgPerCampaign} msgs / campaign` : 'No campaigns yet'
        }),
        kpiCard({
          label: 'Conversion Rate',
          value: `${orderedPct}%`,
          sub: messagesPerOrder ? `1 order per ${messagesPerOrder} msgs` : 'No orders yet'
        })
      ].join('');
    }

    function ensureChart(ctx, type, data, options){
      if (!ctx) return null;
      if (ctx.__chart){ ctx.__chart.destroy(); }
      ctx.__chart = new Chart(ctx, { type, data, options });
      return ctx.__chart;
    }

    function renderCharts(rows){
      const campaignStats = Array.from(buildCampaignStats(rows).values()).sort((a,b) => b.messages - a.messages).slice(0, 15);
      const campaignLabels = campaignStats.map(entry => formatCampaignLabel(entry.id));
      const campaignMessages = campaignStats.map(entry => entry.messages);
      const campaignOrders = campaignStats.map(entry => entry.orders);

      const cctx = document.getElementById('campaignChart');
      ensureChart(cctx, 'bar', {
        labels: campaignLabels,
        datasets: [
          { label: 'Messages', data: campaignMessages, backgroundColor: '#16a34a', borderRadius: 8, maxBarThickness: 36 },
          { label: 'Orders', data: campaignOrders, backgroundColor: '#C6A044', borderRadius: 8, maxBarThickness: 36 }
        ]
      }, {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: true } }
      });

      const ordered = rows.filter(r => isTrue(r.ordered)).length;
      const notOrdered = rows.length - ordered;
      const octx = document.getElementById('orderedChart');
      ensureChart(octx, 'pie', {
        labels: ['Orders', 'No order'],
        datasets: [{ data: [ordered, Math.max(notOrdered, 0)], backgroundColor: ['#C6A044', '#d1fae5'] }]
      }, { responsive: true });

      const adsetStats = Array.from(buildAdsetStats(rows).values()).sort((a,b) => b.messages - a.messages).slice(0, 15);
      const adsetLabels = adsetStats.map(entry => `Ad Set ${entry.idStr}`);
      const adsetMessages = adsetStats.map(entry => entry.messages);
      const actx = document.getElementById('adsetChart');
      ensureChart(actx, 'bar', {
        labels: adsetLabels,
        datasets: [{ label: 'Messages', data: adsetMessages, backgroundColor: '#16a34a', borderRadius: 8, maxBarThickness: 36 }]
      }, {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: true } }
      });

      const ratioCandidates = campaignStats.filter(entry => entry.messages >= 5).sort((a,b) => (b.orders / (b.messages || 1)) - (a.orders / (a.messages || 1))).slice(0, 10);
      const ratioLabels = ratioCandidates.map(entry => formatCampaignLabel(entry.id));
      const ratioData = ratioCandidates.map(entry => Number(((entry.orders / entry.messages) * 100).toFixed(1)));
      const rctx = document.getElementById('campaignRatioChart');
      ensureChart(rctx, 'bar', {
        labels: ratioLabels,
        datasets: [{ label: 'Conversion %', data: ratioData, backgroundColor: '#0f7a37', borderRadius: 8, maxBarThickness: 36 }]
      }, {
        responsive: true,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => {
                const item = ratioCandidates[context.dataIndex];
                if (!item) return `${context.parsed.x ?? 0}%`;
                const rate = typeof context.parsed.x === 'number' ? context.parsed.x.toFixed(1) : context.parsed.x;
                return `${rate}% • ${item.orders.toLocaleString()} orders / ${item.messages.toLocaleString()} msgs`;
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: (value) => `${value}%`
            }
          }
        }
      });
    }

    function recordCard(r){
      const badge = (label) => `<span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-900">${escapeHtml(label)}</span>`;
      const hasOrdered = isTrue(r.ordered);
      const adTitle = r.adid != null ? `Ad ${r.adid}` : 'Ad —';
      const campaignLabel = `Campaign: ${formatCampaignLabel(r.campaignid)}`;
      const adsetLabel = `Ad Set: ${r.adsetid ?? '—'}`;
      const psidLabel = r.psid != null ? `PSID: ${r.psid}` : null;
      return `
        <div class="rounded-2xl border border-emerald-100 bg-white p-4 shadow-soft">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] uppercase tracking-wide text-emerald-800/60">ID #${escapeHtml(r.id)}</div>
              <div class="mt-1 text-lg font-semibold text-emerald-900">${escapeHtml(adTitle)}</div>
            </div>
            <div class="h-9 w-9 rounded-xl flex items-center justify-center ${hasOrdered ? 'bg-brand-gold' : 'bg-emerald-100'}" title="${hasOrdered ? 'Converted' : 'No conversion'}">
              <svg data-lucide="${hasOrdered ? 'check' : 'circle'}" class="w-5 h-5 ${hasOrdered ? 'text-white' : 'text-emerald-700'}"></svg>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            ${badge(campaignLabel)}
            ${badge(adsetLabel)}
            ${psidLabel ? badge(psidLabel) : ''}
          </div>
          <div class="mt-3 text-sm text-emerald-800/80">${hasOrdered ? 'This message generated an order.' : 'Awaiting conversion from this message.'}</div>
        </div>
      `;
    }

    function renderCards(rows){
      const start = pageIndex * PAGE_SIZE;
      const end   = start + PAGE_SIZE;
      const slice = rows.slice(start, end);
      const html = slice.map(recordCard).join('');
      if (pageIndex === 0){
        if (slice.length){
          cardsWrap.innerHTML = html;
        } else {
          cardsWrap.innerHTML = '<div class="md:col-span-2 xl:col-span-3 rounded-2xl border border-dashed border-emerald-200 bg-emerald-50/40 p-6 text-center text-sm text-emerald-700/70">No records match the current filters.</div>';
        }
      } else if (slice.length){
        cardsWrap.insertAdjacentHTML('beforeend', html);
      }
      loadMoreBtn.classList.toggle('hidden', end >= rows.length);
      lucide.createIcons();
    }

    function applyFilters(rows){
      const selectedCampaigns = new Set(campaignFilter.getSelectedValues());
      const selectedAdsets = new Set(adsetFilter.getSelectedValues());
      const orderedFilter = orderedSelect?.value || '';
      return rows.filter(row => {
        const campaignId = row.campaignid !== null && row.campaignid !== undefined ? String(row.campaignid) : null;
        if (selectedCampaigns.size && (!campaignId || !selectedCampaigns.has(campaignId))) return false;
        const adsetId = row.adsetid !== null && row.adsetid !== undefined ? String(row.adsetid) : null;
        if (selectedAdsets.size && (!adsetId || !selectedAdsets.has(adsetId))) return false;
        if (orderedFilter === 'true' && !isTrue(row.ordered)) return false;
        return true;
      });
    }

    function applyFiltersAndRender(){
      const filtered = applyFilters(allRows);
      paginatedRows = filtered;
      pageIndex = 0;
      renderKPIs(filtered);
      renderCharts(filtered);
      renderCards(filtered);
    }

    async function refreshData(){
      try {
        document.body.style.cursor = 'progress';
        await ensureCampaignDirectory();
        const rows = await fetchAll(5000);
        allRows = rows;

        const previousCampaigns = campaignFilter.getSelectedValues();
        const previousAdsets = adsetFilter.getSelectedValues();

        populateCampaignOptions(allRows);
        campaignFilter.setSelectedValues(previousCampaigns);
        updateAdsetOptions();
        adsetFilter.setSelectedValues(previousAdsets);

        applyFiltersAndRender();
      } catch (err){
        console.error(err);
        alert('Failed to fetch data. Check Supabase RLS and credentials.
' + (err.message || err));
      } finally {
        document.body.style.cursor = 'default';
      }
    }

    // Events
    refreshBtn?.addEventListener('click', () => refreshData());
    applyBtn?.addEventListener('click', () => applyFiltersAndRender());
    clearBtn?.addEventListener('click', () => {
      if (orderedSelect) orderedSelect.value = '';
      const campaignChanged = campaignFilter.clear();
      const adsetChanged = adsetFilter.clear();
      if (!campaignChanged){
        updateAdsetOptions();
      }
      if (!campaignChanged && !adsetChanged){
        applyFiltersAndRender();
      }
    });
    orderedSelect?.addEventListener('change', () => applyFiltersAndRender());
    loadMoreBtn?.addEventListener('click', () => {
      pageIndex += 1;
      renderCards(paginatedRows);
    });

    // Boot
    refreshData();
  </script>

</body>
</html>
