<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Best Life Campaigns • ads_damtonda Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              green: '#16a34a',
              greenDark: '#0f7a37',
              gold: '#C6A044',
              cream: '#f6fbf7'
            }
          },
          boxShadow: { soft: '0 10px 25px rgba(0,0,0,0.07)' }
        }
      }
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(8px); }
    .gradient-hero { background: radial-gradient(1200px 600px at 20% -10%, rgba(22,163,74,0.07), transparent), radial-gradient(900px 500px at 100% 0%, rgba(198,160,68,0.08), transparent); }
  </style>
</head>
<body class="bg-brand-cream min-h-screen gradient-hero">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 glass border-b border-emerald-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-brand-green flex items-center justify-center shadow-soft">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" class="h-6 w-6">
            <path d="M12 4v16M4 12h16"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-brand-green">Best Life Campaigns</h1>
          <p class="text-xs sm:text-sm text-emerald-800/60">ads_damtonda — Health-inspired analytics</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-brand-green text-white font-medium hover:bg-brand-greenDark transition shadow-soft">Refresh</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Filters Card -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5 sm:p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="filter" class="w-5 h-5 text-brand-gold"></svg>
        <h2 class="text-lg font-semibold text-emerald-900">Filters</h2>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Campaigns</label>
          <select id="f-campaignid" multiple size="6" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none min-h-[140px]">
          </select>
          <p class="mt-1 text-[11px] text-emerald-800/60">Use Ctrl/Cmd or Shift to compare multiple campaigns.</p>
        </div>
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Ad Sets</label>
          <select id="f-adsetid" multiple size="6" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none min-h-[140px]">
          </select>
          <p class="mt-1 text-[11px] text-emerald-800/60">Ad sets update automatically based on the selected campaigns.</p>
        </div>
        <div class="sm:col-span-2">
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Ordered</label>
          <select id="f-ordered" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none">
            <option value="">Any</option>
            <option value="true">Ordered only</option>
          </select>
        </div>
        <div class="flex items-end gap-3">
          <button id="applyBtn" class="flex-1 px-4 py-2 rounded-xl bg-brand-gold text-white font-semibold shadow-soft hover:opacity-90">Apply</button>
          <button id="clearBtn" class="px-4 py-2 rounded-xl border border-emerald-200 text-emerald-900 font-medium hover:bg-emerald-50">Clear</button>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section id="kpis" class="grid sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-6"></section>

    <!-- Charts -->
    <section class="grid lg:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="bar-chart-3" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Records by Campaign ID</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="campaignChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="pie-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Ordered vs Not</h3>
          </div>
        </div>
        <canvas id="orderedChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="percent" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Orders per 100 Messages</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 12</span>
        </div>
        <div id="ordersMessagesEmpty" class="text-sm text-emerald-800/60 bg-emerald-50 border border-emerald-100 rounded-2xl p-4 hidden">
          Message activity data is not available for the current selection.
        </div>
        <canvas id="ordersMessagesChart" height="240" class="hidden"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5 lg:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="line-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Records by Ad Set ID</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="adsetChart" height="240"></canvas>
      </div>
    </section>

    <!-- Cards List -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="list" class="w-5 h-5 text-brand-gold"></svg>
        <h3 class="font-semibold text-emerald-900">Latest Records</h3>
      </div>
      <div id="cards" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      <div id="loadMoreWrap" class="mt-6 flex justify-center">
        <button id="loadMoreBtn" class="px-5 py-2 rounded-xl bg-emerald-100 text-emerald-900 font-medium hover:bg-emerald-200 hidden">Load more</button>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-emerald-900/60">
    <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100">Made for Best Life — golden accents on white & green ✨</span>
  </footer>

  <!-- Supabase JS v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://whmbrguzumyatnslzfsq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobWJyZ3V6dW15YXRuc2x6ZnNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNTE2ODksImV4cCI6MjA2NDkyNzY4OX0.xcSogaAHv8uQzhFgEDZ1niFx8lirLiBRvkPpMF174YM';
    const TABLE = 'ads_damtonda';
    const LIST_URL = 'https://primary-production-9e01d.up.railway.app/webhook/88011745-0650-4fdc-9caa-628ed08eab95';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const $ = (s, p=document) => p.querySelector(s);

    // UI elements
    const refreshBtn = $('#refreshBtn');
    const applyBtn   = $('#applyBtn');
    const clearBtn   = $('#clearBtn');
    const loadMoreBtn= $('#loadMoreBtn');
    const cardsWrap  = $('#cards');
    const kpisWrap   = $('#kpis');

    const fCampaign  = $('#f-campaignid');
    const fAdset     = $('#f-adsetid');
    const fOrdered   = $('#f-ordered');

    const ordersMessagesCanvas = $('#ordersMessagesChart');
    const ordersMessagesEmpty  = $('#ordersMessagesEmpty');

    // Charts
    let campaignChart, orderedChart, adsetChart, ordersMessagesChart;

    // State
    let paginatedRows = [];
    let allRows = [];
    let masterRows = [];
    const PAGE_SIZE = 36;
    let pageIndex = 0;
    let campaignNameMap = new Map();
    let campaignDirectoryLoaded = false;
    let directoryPromise = null;
    let messageField = null;

    // Icons
    lucide.createIcons();

    // ---- helpers ----
    const toNumberOrNull = (v) => {
      const t = String(v||'').trim();
      if (!t) return null;
      return /^-?\\d+(?:\\.\\d+)?$/.test(t) ? Number(t) : null;
    };

    const isTrue = (val) => (val === true || val === 1 || (typeof val === 'string' && ['true','t','1','yes','y'].includes(val.toLowerCase())));

    const getSelectedNumbers = (select) => {
      if (!select) return [];
      return Array.from(select.selectedOptions || [])
        .map(opt => toNumberOrNull(opt.value))
        .filter(v => v !== null);
    };

    function clearMultiSelection(select){
      if (!select) return;
      Array.from(select.options || []).forEach(opt => { opt.selected = false; });
    }

    function normalizeMetricValue(value){
      if (value === null || value === undefined) return 0;
      if (typeof value === 'number' && Number.isFinite(value)) return value;
      if (typeof value === 'boolean') return value ? 1 : 0;
      if (typeof value === 'bigint') return Number(value);
      if (typeof value === 'string'){
        const trimmed = value.trim();
        if (!trimmed) return 0;
        const numeric = Number(trimmed.replace(/,/g, ''));
        if (!Number.isNaN(numeric)) return numeric;
        const lowered = trimmed.toLowerCase();
        if (['true','t','yes','y','1'].includes(lowered)) return 1;
        if (['false','f','no','n','0'].includes(lowered)) return 0;
      }
      return 0;
    }

    function formatMetricValue(value){
      if (!Number.isFinite(value)) value = 0;
      if (value === 0) return '0';
      const abs = Math.abs(value);
      if (abs >= 1000) return Math.round(value).toLocaleString();
      if (abs >= 1) return Number(value.toFixed(1)).toLocaleString();
      return Number(value.toFixed(2)).toLocaleString();
    }

    function parseCampaignLine(line){
      if (typeof line !== 'string') return null;
      const clean = line.replace(/\r/g,'').trim();
      const idx = clean.indexOf(' - ');
      if (idx === -1){
        const idOnly = clean.trim();
        return { id: idOnly, name: '' };
      }
      const id = clean.slice(0, idx).trim();
      const name = clean.slice(idx + 3).replace(/\s+/g,' ').trim();
      return { id, name };
    }

    function normalizeCampaignDirectory(data){
      try {
        if (!data) return [];
        let root = Array.isArray(data) ? data[0] : data;
        if (!root) return [];
        let arr = root['all campaigns'] || root['all_campaigns'] || root['campaigns'] || root['data'];
        if (!Array.isArray(arr)){
          arr = Array.isArray(data) ? data : [];
        }
        const unique = new Map();
        for (const item of arr){
          const parsed = parseCampaignLine(item);
          if (parsed && parsed.id){
            unique.set(parsed.id, parsed);
          }
        }
        return Array.from(unique.values());
      } catch (err){
        return [];
      }
    }

    async function loadCampaignDirectory(force = false){
      if (!force && (campaignDirectoryLoaded || directoryPromise)){
        return directoryPromise || Promise.resolve();
      }
      if (force && directoryPromise){
        try { await directoryPromise; } catch { /* ignore */ }
        directoryPromise = null;
      }
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), 45000);
      const task = (async () => {
        try {
          const res = await fetch(LIST_URL, { method: 'GET', mode: 'cors', cache: 'no-store', signal: controller.signal });
          const text = await res.text();
          let payload = text;
          try { payload = JSON.parse(text); } catch { /* keep string */ }
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const entries = normalizeCampaignDirectory(payload);
          const map = new Map();
          for (const entry of entries){
            const name = (entry.name || '').trim();
            const idStr = String(entry.id ?? '').trim();
            const num = toNumberOrNull(entry.id);
            if (num !== null) map.set(num, name);
            if (idStr) map.set(idStr, name);
          }
          if (map.size){
            campaignNameMap = map;
            campaignDirectoryLoaded = true;
          }
        } catch (err){
          console.warn('[campaign-directory] load failed', err?.message || err);
          if (!campaignDirectoryLoaded) campaignNameMap = new Map();
        } finally {
          clearTimeout(timer);
        }
      })();
      directoryPromise = task.finally(() => {
        if (directoryPromise === task) directoryPromise = null;
      });
      return directoryPromise;
    }

    function formatCampaignLabel(id){
      if (id === null || id === undefined || id === '') return '—';
      const numeric = typeof id === 'number' ? id : toNumberOrNull(id);
      const lookup = (numeric !== null && campaignNameMap.get(numeric)) || campaignNameMap.get(String(id).trim());
      if (lookup){
        return `${lookup} (${id})`;
      }
      return `ID ${id}`;
    }

    function getMessageValue(row){
      if (!messageField || !row) return 0;
      return normalizeMetricValue(row[messageField]);
    }

    function detectMessageField(rows){
      if (!rows || !rows.length) return null;
      const scores = new Map();
      for (const row of rows){
        if (!row || typeof row !== 'object') continue;
        for (const [key, value] of Object.entries(row)){
          if (!key || typeof key !== 'string') continue;
          const lower = key.toLowerCase();
          if (!lower.includes('message')) continue;
          const numeric = normalizeMetricValue(value);
          if (numeric <= 0) continue;
          const bonus = lower.includes('start') ? 1.5 : 1;
          scores.set(key, (scores.get(key) || 0) + bonus);
        }
      }
      if (!scores.size) return null;
      return Array.from(scores.entries()).sort((a,b)=>b[1]-a[1])[0][0];
    }

    function aggregateByCampaign(rows){
      const map = new Map();
      for (const row of rows){
        const id = row.campaignid;
        if (id === null || id === undefined || id === '') continue;
        if (!map.has(id)) map.set(id, { total: 0, orders: 0, messages: 0 });
        const entry = map.get(id);
        entry.total += 1;
        if (isTrue(row.ordered)) entry.orders += 1;
        const messages = getMessageValue(row);
        if (messages) entry.messages += messages;
      }
      return map;
    }

    function buildFiltersOn(query){
      const campaigns = getSelectedNumbers(fCampaign);
      const adsets = getSelectedNumbers(fAdset);
      const o = fOrdered.value;

      if (campaigns.length) query = query.in('campaignid', campaigns);
      if (adsets.length) query = query.in('adsetid', adsets);
      if (o === 'true') query = query.eq('ordered', true);
      return query;
    }

    async function trySupabaseChunk(from, to){
      try {
        let q = supabase.from(TABLE).select('*').order('id', { ascending: false }).range(from, to);
        q = buildFiltersOn(q);
        const { data, error } = await q;
        if (error) throw error;
        return data;
      } catch (e){
        console.warn('[supabase-js] chunk err:', e?.message||e);
        return null;
      }
    }

    async function tryRestChunk(from, to){
      const params = new URLSearchParams({ select: '*', order: 'id.desc' });
      const campaigns = getSelectedNumbers(fCampaign);
      const adsets = getSelectedNumbers(fAdset);
      const o = fOrdered.value;
      if (campaigns.length) params.set('campaignid', `in.(${campaigns.join(',')})`);
      if (adsets.length) params.set('adsetid', `in.(${adsets.join(',')})`);
      if (o === 'true') params.set('ordered', 'is.true');

      const url = `${SUPABASE_URL}/rest/v1/${TABLE}?` + params.toString();
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          Range: `${from}-${to}`,
          Accept: 'application/json'
        }
      });
      if (!res.ok) throw new Error(`REST ${res.status}`);
      return await res.json();
    }

    async function fetchAll(limit=5000){
      const batch = 1000;
      let from = 0, to = Math.min(batch-1, limit-1);
      const out = [];
      let usedRest = false;

      while (from < limit){
        let chunk = await trySupabaseChunk(from, to);
        if (chunk === null){ usedRest = true; chunk = await tryRestChunk(from, to); }
        out.push(...chunk);
        if (chunk.length < (to-from+1)) break;
        from += batch; to = Math.min(to + batch, limit-1);
      }
      if (usedRest) console.info('Using REST fallback');
      return out;
    }

    function kpiCard({label, value, sub}) {
      return `
        <div class="bg-white border border-emerald-100 rounded-2xl p-4 shadow-soft">
          <div class="text-xs font-semibold text-emerald-800/70">${label}</div>
          <div class="mt-1 text-2xl font-extrabold text-emerald-900">${value}</div>
          ${sub ? `<div class="text-xs text-emerald-800/60 mt-1">${sub}</div>` : ''}
        </div>
      `;
    }

    function renderKPIs(rows){
      const total = rows.length;
      const uniq = (arr, key) => new Set(arr.map(r => r[key]).filter(v => v !== null && v !== undefined && v !== '')).size;
      const uniqCampaigns = uniq(rows, 'campaignid');
      const uniqAdsets    = uniq(rows, 'adsetid');
      const orderedCount  = rows.filter(r => isTrue(r.ordered)).length;
      const orderedPct    = total ? Math.round((orderedCount/Math.max(total,1))*100) : 0;
      const messagesTotal = messageField ? rows.reduce((sum, row) => sum + getMessageValue(row), 0) : 0;
      const ordersPer100  = messageField && messagesTotal > 0 ? (orderedCount / messagesTotal) * 100 : 0;

      kpisWrap.innerHTML = [
        kpiCard({ label: 'Total Records', value: total.toLocaleString() }),
        kpiCard({ label: 'Unique Campaigns', value: uniqCampaigns.toLocaleString() }),
        kpiCard({ label: 'Unique Ad Sets', value: uniqAdsets.toLocaleString() }),
        kpiCard({
          label: 'Messages Started',
          value: messageField ? formatMetricValue(messagesTotal) : '—',
          sub: messageField ? `Field: ${messageField}` : 'No message data'
        }),
        kpiCard({
          label: 'Orders per 100 Messages',
          value: messageField && messagesTotal > 0 ? ordersPer100.toFixed(2) : '—',
          sub: `${orderedCount.toLocaleString()} orders (${orderedPct}% of records)`
        })
      ].join('');
    }

    function topCounts(rows, key, topN=15, labelFormatter = (val) => String(val)){
      const m = new Map();
      for (const r of rows){
        const k = r[key];
        if (k !== null && k !== undefined && k !== '') m.set(k, (m.get(k)||0)+1);
      }
      const arr = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0, topN);
      return { labels: arr.map(([value]) => labelFormatter(value)), counts: arr.map(([,count]) => count) };
    }

    function ensureChart(ctx, type, data, options){
      if (!ctx) return null;
      if (ctx.__chart){ ctx.__chart.destroy(); }
      ctx.__chart = new Chart(ctx, { type, data, options });
      return ctx.__chart;
    }

    function renderOrdersMessagesChart(rows){
      if (!ordersMessagesCanvas || !ordersMessagesEmpty) return;
      const metrics = aggregateByCampaign(rows);
      const dataset = Array.from(metrics.entries()).map(([id, stats]) => {
        const ratio = stats.messages > 0 ? (stats.orders / stats.messages) * 100 : 0;
        return {
          id,
          label: formatCampaignLabel(id),
          orders: stats.orders,
          messages: stats.messages,
          ratio
        };
      }).filter(item => item.messages > 0 && Number.isFinite(item.ratio));

      dataset.sort((a,b)=>b.ratio - a.ratio);
      const top = dataset.slice(0, 12);

      if (!messageField || top.length === 0){
        ordersMessagesEmpty.classList.remove('hidden');
        ordersMessagesCanvas.classList.add('hidden');
        if (ordersMessagesCanvas.__chart){ ordersMessagesCanvas.__chart.destroy(); ordersMessagesCanvas.__chart = null; }
        return;
      }

      ordersMessagesEmpty.classList.add('hidden');
      ordersMessagesCanvas.classList.remove('hidden');

      const data = {
        labels: top.map(item => item.label),
        datasets: [{
          label: 'Orders per 100 Messages',
          data: top.map(item => Number(item.ratio.toFixed(2))),
          backgroundColor: '#16a34a',
          borderRadius: 6,
          maxBarThickness: 36
        }]
      };

      const options = {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label(context){
                const item = top[context.dataIndex];
                return [
                  `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`,
                  `${item.orders.toLocaleString()} orders`,
                  `${formatMetricValue(item.messages)} messages`
                ];
              }
            }
          }
        },
        scales: {
          x: { ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 } },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Orders per 100 Messages' }
          }
        }
      };

      ordersMessagesChart = ensureChart(ordersMessagesCanvas, 'bar', data, options);
    }

    function renderCharts(rows){
      const cctx = document.getElementById('campaignChart');
      const cc = topCounts(rows, 'campaignid', 15, formatCampaignLabel);
      campaignChart = ensureChart(cctx, 'bar', {
        labels: cc.labels,
        datasets: [{
          label: 'Records',
          data: cc.counts,
          backgroundColor: '#16a34a',
          borderRadius: 6,
          maxBarThickness: 40
        }]
      }, {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 } },
          y: { beginAtZero: true }
        }
      });

      const ordered = rows.filter(r => isTrue(r.ordered)).length;
      const notOrdered = rows.length - ordered;
      const octx = document.getElementById('orderedChart');
      orderedChart = ensureChart(octx, 'pie', {
        labels: ['Ordered', 'Not ordered'],
        datasets: [{
          data: [ordered, Math.max(notOrdered, 0)],
          backgroundColor: ['#16a34a', '#e2f5ea']
        }]
      }, {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      });

      const actx = document.getElementById('adsetChart');
      const ac = topCounts(rows, 'adsetid', 15);
      adsetChart = ensureChart(actx, 'bar', {
        labels: ac.labels,
        datasets: [{
          label: 'Records',
          data: ac.counts,
          backgroundColor: '#c6a044',
          borderRadius: 6,
          maxBarThickness: 40
        }]
      }, {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 } },
          y: { beginAtZero: true }
        }
      });

      renderOrdersMessagesChart(rows);
    }

    function recordCard(r){
      const badge = (label) => `<span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-900">${label}</span>`;
      const hasOrdered = isTrue(r.ordered);
      const campaignLabel = formatCampaignLabel(r.campaignid ?? '—');
      const messageCount = getMessageValue(r);
      const messageBadge = messageField && messageCount ? badge('Messages: ' + formatMetricValue(messageCount)) : '';
      return `
        <div class="rounded-2xl border border-emerald-100 bg-white p-4 shadow-soft">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] uppercase tracking-wide text-emerald-800/60">ID #${r.id}</div>
              <div class="mt-1 text-lg font-semibold text-emerald-900">Ad ${r.adid ?? '—'}</div>
            </div>
            <div class="h-9 w-9 rounded-xl flex items-center justify-center ${hasOrdered ? 'bg-brand-gold' : 'bg-emerald-100'}" title="Ordered">
              <svg data-lucide="${hasOrdered ? 'check' : 'circle'}" class="w-5 h-5 ${hasOrdered ? 'text-white' : 'text-emerald-700'}"></svg>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            ${badge('Campaign: ' + campaignLabel)}
            ${badge('Ad Set: ' + (r.adsetid ?? '—'))}
            ${messageBadge}
            ${r.psid != null ? badge('PSID: ' + r.psid) : ''}
          </div>
          ${hasOrdered ? `<div class="mt-3 text-sm text-emerald-900"><span class="font-semibold">Ordered:</span> TRUE</div>` : ''}
        </div>
      `;
    }

    function renderCards(rows){
      if (!rows.length){
        cardsWrap.innerHTML = '<div class="col-span-full rounded-2xl border border-emerald-100 bg-emerald-50/60 p-4 text-sm text-emerald-800/70">No records match the current filters yet.</div>';
        loadMoreBtn.classList.add('hidden');
        return;
      }
      const start = pageIndex * PAGE_SIZE;
      const end   = start + PAGE_SIZE;
      const slice = rows.slice(start, end);
      const html = slice.map(recordCard).join('');
      if (pageIndex === 0) cardsWrap.innerHTML = html; else cardsWrap.insertAdjacentHTML('beforeend', html);
      loadMoreBtn.classList.toggle('hidden', end >= rows.length);
      lucide.createIcons();
    }

    function populateDropdowns(rows, { preserveSelection = true } = {}){
      if (!fCampaign || !fAdset) return;
      const selectedCampaigns = preserveSelection ? getSelectedNumbers(fCampaign) : [];
      const selectedAdsets = preserveSelection ? getSelectedNumbers(fAdset) : [];
      if (!rows || !rows.length){
        fCampaign.innerHTML = '';
        fAdset.innerHTML = '';
        return;
      }

      const campaignSet = new Set(rows.map(r => r.campaignid).filter(v => v !== null && v !== undefined && v !== ''));
      for (const id of selectedCampaigns){
        if (id !== null) campaignSet.add(id);
      }
      const campaigns = Array.from(campaignSet).sort((a,b)=>a-b);
      fCampaign.innerHTML = campaigns.map(id => `<option value="${id}">${formatCampaignLabel(id)}</option>`).join('');
      if (selectedCampaigns.length){
        const selectedSet = new Set(selectedCampaigns);
        Array.from(fCampaign.options).forEach(opt => {
          const val = toNumberOrNull(opt.value);
          if (val !== null && selectedSet.has(val)) opt.selected = true;
        });
      }

      const campaignFilter = selectedCampaigns.length ? new Set(selectedCampaigns) : null;
      const adsetSource = campaignFilter ? rows.filter(r => campaignFilter.has(r.campaignid)) : rows;
      const adsetSet = new Set(adsetSource.map(r => r.adsetid).filter(v => v !== null && v !== undefined && v !== ''));
      for (const id of selectedAdsets){
        if (id !== null) adsetSet.add(id);
      }
      const adsets = Array.from(adsetSet).sort((a,b)=>a-b);
      fAdset.innerHTML = adsets.map(id => `<option value="${id}">${id}</option>`).join('');
      if (selectedAdsets.length){
        const selectedSet = new Set(selectedAdsets);
        Array.from(fAdset.options).forEach(opt => {
          const val = toNumberOrNull(opt.value);
          if (val !== null && selectedSet.has(val)) opt.selected = true;
        });
      }
    }
    async function run(options = {}){
      const { forceDirectory = false } = options;
      try {
        document.body.style.cursor = 'progress';
        await loadCampaignDirectory(forceDirectory);
        const rows = await fetchAll(5000);
        allRows = rows;

        const selectedCampaigns = getSelectedNumbers(fCampaign);
        const selectedAdsets = getSelectedNumbers(fAdset);
        const orderedActive = fOrdered.value === 'true';
        const filtersActive = selectedCampaigns.length || selectedAdsets.length || orderedActive;

        if (!filtersActive || !masterRows.length){
          masterRows = rows;
        }

        const dropdownSource = masterRows.length ? masterRows : rows;
        if (dropdownSource.length){
          const detected = detectMessageField(dropdownSource);
          if (detected) messageField = detected;
        }

        populateDropdowns(dropdownSource, { preserveSelection: true });
        renderKPIs(rows);
        renderCharts(rows);
        paginatedRows = rows;
        pageIndex = 0;
        renderCards(paginatedRows);
      } catch (err){
        console.error(err);
        alert('Failed to fetch data. Check Supabase RLS and credentials.\n' + (err.message || err));
      } finally {
        document.body.style.cursor = 'default';
      }
    }

    // Events
    refreshBtn.addEventListener('click', () => {
      campaignDirectoryLoaded = false;
      masterRows = [];
      messageField = null;
      run({ forceDirectory: true });
    });
    applyBtn.addEventListener('click', () => run());
    clearBtn.addEventListener('click', () => {
      clearMultiSelection(fCampaign);
      clearMultiSelection(fAdset);
      fOrdered.value = '';
      populateDropdowns(masterRows.length ? masterRows : allRows, { preserveSelection: false });
      run();
    });
    loadMoreBtn.addEventListener('click', () => {
      pageIndex += 1;
      renderCards(paginatedRows);
    });
    fCampaign.addEventListener('change', () => {
      populateDropdowns(masterRows.length ? masterRows : allRows, { preserveSelection: true });
    });
    fOrdered.addEventListener('change', () => run());

    // Boot
    run();
  </script>
</body>
</html>
