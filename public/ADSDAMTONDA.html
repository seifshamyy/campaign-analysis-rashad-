<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Best Life Campaigns • ads_damtonda Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              green: '#16a34a',
              greenDark: '#0f7a37',
              gold: '#C6A044',
              cream: '#f6fbf7'
            }
          },
          boxShadow: { soft: '0 10px 25px rgba(0,0,0,0.07)' }
        }
      }
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(8px); }
    .gradient-hero { background: radial-gradient(1200px 600px at 20% -10%, rgba(22,163,74,0.07), transparent), radial-gradient(900px 500px at 100% 0%, rgba(198,160,68,0.08), transparent); }
  </style>
</head>
<body class="bg-brand-cream min-h-screen gradient-hero">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 glass border-b border-emerald-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-brand-green flex items-center justify-center shadow-soft">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" class="h-6 w-6">
            <path d="M12 4v16M4 12h16"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-brand-green">Best Life Campaigns</h1>
          <p class="text-xs sm:text-sm text-emerald-800/60">ads_damtonda — Health-inspired analytics</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-brand-green text-white font-medium hover:bg-brand-greenDark transition shadow-soft">Refresh</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Filters Card -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5 sm:p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="filter" class="w-5 h-5 text-brand-gold"></svg>
        <h2 class="text-lg font-semibold text-emerald-900">Filters</h2>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Campaign ID</label>
          <select multiple size="6" id="f-campaignid" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none"></select>
          <p class="mt-1 text-[11px] text-emerald-700/70">Use Ctrl/⌘ or Shift to compare multiple campaigns.</p>
        </div>
        <div>
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Ad Set ID</label>
          <select multiple size="6" id="f-adsetid" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none"></select>
          <p class="mt-1 text-[11px] text-emerald-700/70">Ad sets are scoped to the selected campaigns.</p>
        </div>
        <div class="sm:col-span-2">
          <label class="block text-xs font-semibold text-emerald-900/80 mb-1">Ordered</label>
          <select id="f-ordered" class="w-full rounded-xl border border-emerald-100 bg-emerald-50/40 px-3 py-2 focus:ring-2 focus:ring-brand-gold/50 outline-none">
            <option value="">Any</option>
            <option value="true">Ordered only</option>
          </select>
        </div>
        <div class="flex items-end gap-3">
          <button id="applyBtn" class="flex-1 px-4 py-2 rounded-xl bg-brand-gold text-white font-semibold shadow-soft hover:opacity-90">Apply</button>
          <button id="clearBtn" class="px-4 py-2 rounded-xl border border-emerald-200 text-emerald-900 font-medium hover:bg-emerald-50">Clear</button>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section id="kpis" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></section>

    <!-- Charts -->
    <section class="grid lg:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="bar-chart-3" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Records by Campaign</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="campaignChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="pie-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Ordered vs Not</h3>
          </div>
        </div>
        <canvas id="orderedChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="line-chart" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Records by Ad Set ID</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 15</span>
        </div>
        <canvas id="adsetChart" height="240"></canvas>
      </div>
      <div class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <svg data-lucide="percent" class="w-5 h-5 text-brand-gold"></svg>
            <h3 class="font-semibold text-emerald-900">Orders per Message</h3>
          </div>
          <span class="text-xs text-emerald-800/60">Top 10 by messages</span>
        </div>
        <div class="relative">
          <canvas id="ratioChart" height="240"></canvas>
          <div id="ratioEmpty" class="absolute inset-0 flex items-center justify-center text-sm text-emerald-800/70 hidden">
            No message data available for the current selection.
          </div>
        </div>
      </div>
    </section>

    <!-- Cards List -->
    <section class="bg-white rounded-3xl shadow-soft border border-emerald-50 p-5">
      <div class="flex items-center gap-2 mb-4">
        <svg data-lucide="list" class="w-5 h-5 text-brand-gold"></svg>
        <h3 class="font-semibold text-emerald-900">Latest Records</h3>
      </div>
      <div id="cards" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      <div id="loadMoreWrap" class="mt-6 flex justify-center">
        <button id="loadMoreBtn" class="px-5 py-2 rounded-xl bg-emerald-100 text-emerald-900 font-medium hover:bg-emerald-200 hidden">Load more</button>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-emerald-900/60">
    <span class="px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100">Made for Best Life — golden accents on white & green ✨</span>
  </footer>

  <!-- Supabase JS v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://whmbrguzumyatnslzfsq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndobWJyZ3V6dW15YXRuc2x6ZnNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNTE2ODksImV4cCI6MjA2NDkyNzY4OX0.xcSogaAHv8uQzhFgEDZ1niFx8lirLiBRvkPpMF174YM';
    const TABLE = 'ads_damtonda';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const $ = (s, p=document) => p.querySelector(s);

    // UI elements
    const refreshBtn = $('#refreshBtn');
    const applyBtn   = $('#applyBtn');
    const clearBtn   = $('#clearBtn');
    const loadMoreBtn= $('#loadMoreBtn');
    const cardsWrap  = $('#cards');
    const kpisWrap   = $('#kpis');

    const fCampaign  = $('#f-campaignid');
    const fAdset     = $('#f-adsetid');
    const fOrdered   = $('#f-ordered');

    // Charts
    let campaignChart, orderedChart, adsetChart, ratioChart;

    // State
    let paginatedRows = [];
    let masterRows = [];
    let filteredRows = [];
    const PAGE_SIZE = 36;
    let pageIndex = 0;
    let messageFieldName = null;
    const campaignDirectory = new Map();
    let directoryLoaded = false;

    // Icons
    lucide.createIcons();

    // ---- helpers ----
    const toNumberOrNull = (v) => {
      const t = String(v||'').trim();
      if (!t) return null;
      return /^-?\\d+(?:\\.\\d+)?$/.test(t) ? Number(t) : null;
    };

    const isTrue = (val) => (val === true || val === 1 || (typeof val === 'string' && ['true','t','1','yes','y'].includes(val.toLowerCase())));

    function getSelectedNumbers(select){
      return Array.from(select?.selectedOptions || [])
        .map(opt => toNumberOrNull(opt.value))
        .filter(v => v !== null);
    }

    function setSelectedValues(select, values){
      const set = new Set(values.map(v => String(v)));
      Array.from(select?.options || []).forEach(opt => {
        opt.selected = set.has(opt.value);
      });
      if (!set.size) select.selectedIndex = -1;
    }

    function clearMulti(select){
      Array.from(select?.options || []).forEach(opt => { opt.selected = false; });
      select.selectedIndex = -1;
    }

    function currentFilters(){
      const campaigns = getSelectedNumbers(fCampaign);
      const adsets = getSelectedNumbers(fAdset);
      const orderedVal = fOrdered.value === 'true' ? true : null;
      return { campaigns, adsets, orderedVal };
    }

    function buildFiltersOn(query, filters){
      const { campaigns, adsets, orderedVal } = filters;
      if (campaigns.length === 1) query = query.eq('campaignid', campaigns[0]);
      else if (campaigns.length > 1) query = query.in('campaignid', campaigns);

      if (adsets.length === 1) query = query.eq('adsetid', adsets[0]);
      else if (adsets.length > 1) query = query.in('adsetid', adsets);

      if (orderedVal === true) query = query.eq('ordered', true);
      return query;
    }

    async function trySupabaseChunk(from, to, filters){
      try {
        let q = supabase.from(TABLE).select('*').order('id', { ascending: false }).range(from, to);
        q = buildFiltersOn(q, filters);
        const { data, error } = await q;
        if (error) throw error;
        return data;
      } catch (e){
        console.warn('[supabase-js] chunk err:', e?.message||e);
        return null;
      }
    }

    async function tryRestChunk(from, to, filters){
      const params = new URLSearchParams({ select: '*', order: 'id.desc' });
      const { campaigns, adsets, orderedVal } = filters;
      if (campaigns.length === 1) params.set('campaignid', `eq.${campaigns[0]}`);
      else if (campaigns.length > 1) params.set('campaignid', `in.(${campaigns.join(',')})`);

      if (adsets.length === 1) params.set('adsetid', `eq.${adsets[0]}`);
      else if (adsets.length > 1) params.set('adsetid', `in.(${adsets.join(',')})`);

      if (orderedVal === true) params.set('ordered', 'is.true');

      const url = `${SUPABASE_URL}/rest/v1/${TABLE}?` + params.toString();
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          Range: `${from}-${to}`,
          Accept: 'application/json'
        }
      });
      if (!res.ok) throw new Error(`REST ${res.status}`);
      return await res.json();
    }

    async function fetchAll(limit=5000, { applyFilters = true } = {}){
      const filters = applyFilters ? currentFilters() : { campaigns: [], adsets: [], orderedVal: null };
      const batch = 1000;
      let from = 0, to = Math.min(batch-1, limit-1);
      const out = [];
      let usedRest = false;

      while (from < limit){
        let chunk = await trySupabaseChunk(from, to, filters);
        if (chunk === null){ usedRest = true; chunk = await tryRestChunk(from, to, filters); }
        out.push(...chunk);
        if (chunk.length < (to-from+1)) break;
        from += batch; to = Math.min(to + batch, limit-1);
      }
      if (usedRest) console.info('Using REST fallback');
      return out;
    }

    const MESSAGE_FIELD_CANDIDATES = [
      'messages_started','message_started','messagestarted','messagesstarted','messages','messagecount','message_count','messages_count','messageinitiated','messagesinitiated','messages_total','messagesent'
    ];

    function detectMessageField(rows){
      if (!rows || !rows.length) return null;
      const candidates = new Map();
      for (const row of rows){
        if (!row || typeof row !== 'object') continue;
        for (const key of Object.keys(row)){
          if (!key) continue;
          const lower = key.toLowerCase();
          if (!candidates.has(lower)) candidates.set(lower, key);
        }
      }
      for (const cand of MESSAGE_FIELD_CANDIDATES){
        if (candidates.has(cand)) return candidates.get(cand);
      }
      for (const [lower, original] of candidates.entries()){
        if (lower.includes('message')) return original;
      }
      return null;
    }

    function parseMessageValue(val){
      if (val === null || val === undefined) return 0;
      if (typeof val === 'number' && Number.isFinite(val)) return val;
      if (typeof val === 'boolean') return val ? 1 : 0;
      if (typeof val === 'string'){
        const trimmed = val.trim();
        if (!trimmed) return 0;
        const lower = trimmed.toLowerCase();
        if (['true','t','1','yes','y'].includes(lower)) return 1;
        const numeric = Number(trimmed.replace(/,/g,''));
        return Number.isFinite(numeric) ? numeric : 0;
      }
      return 0;
    }

    function aggregateByCampaign(rows){
      const summary = new Map();
      for (const r of rows){
        const id = r.campaignid;
        if (id === null || id === undefined || id === '') continue;
        if (!summary.has(id)) summary.set(id, { campaignid: id, orders: 0, messages: 0 });
        const item = summary.get(id);
        if (isTrue(r.ordered)) item.orders += 1;
        if (messageFieldName){
          item.messages += parseMessageValue(r[messageFieldName]);
        }
      }
      return Array.from(summary.values());
    }

    const LIST_URL = 'https://primary-production-9e01d.up.railway.app/webhook/88011745-0650-4fdc-9caa-628ed08eab95';

    async function fetchJson(url, options={}){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), 120000);
      try {
        const res = await fetch(url, { mode: 'cors', cache: 'no-store', signal: controller.signal, ...options });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }
        return { ok: res.ok, status: res.status, data, raw: text };
      } catch (err){
        return { ok: false, status: 0, data: null, raw: err?.message || String(err) };
      } finally {
        clearTimeout(t);
      }
    }

    function parseCampaignLine(line){
      if (typeof line !== 'string') return null;
      const clean = line.replace(/\r/g,'').trim();
      if (!clean) return null;
      const idx = clean.indexOf(' - ');
      if (idx === -1) {
        const idOnly = clean.trim();
        return { id: idOnly, name: '' };
      }
      const id = clean.slice(0, idx).trim();
      const name = clean.slice(idx + 3).replace(/\s+/g,' ').trim();
      return { id, name };
    }

    function normalizeCampaignDirectory(payload){
      if (!payload) return [];
      const root = Array.isArray(payload) ? payload[0] : payload;
      if (!root || typeof root !== 'object') return [];
      const arr = root['all campaigns'] || root['all_campaigns'] || root['campaigns'] || [];
      if (!Array.isArray(arr)) return [];
      const unique = new Map();
      for (const item of arr){
        const parsed = parseCampaignLine(item);
        if (parsed && parsed.id) unique.set(parsed.id, parsed);
      }
      return Array.from(unique.values());
    }

    async function loadCampaignDirectory(force=false){
      if (directoryLoaded && !force) return;
      try {
        const res = await fetchJson(LIST_URL, { method: 'GET' });
        if (!res.ok) throw new Error(`Directory request failed (${res.status})`);
        let payload = res.data;
        if (typeof payload === 'string'){
          try { payload = JSON.parse(payload); } catch {}
        }
        const entries = normalizeCampaignDirectory(payload);
        campaignDirectory.clear();
        for (const entry of entries){
          const id = String(entry.id || '').trim();
          if (!id) continue;
          campaignDirectory.set(id, entry.name || '');
        }
        directoryLoaded = true;
      } catch (err){
        console.warn('Campaign directory fetch failed', err);
      }
    }

    function formatCampaignLabel(id){
      if (id === null || id === undefined || id === '') return '—';
      const strId = String(id);
      const name = campaignDirectory.get(strId);
      return name ? `${name} (${strId})` : strId;
    }

    function kpiCard({label, value, sub}) {
      return `
        <div class="bg-white border border-emerald-100 rounded-2xl p-4 shadow-soft">
          <div class="text-xs font-semibold text-emerald-800/70">${label}</div>
          <div class="mt-1 text-2xl font-extrabold text-emerald-900">${value}</div>
          ${sub ? `<div class="text-xs text-emerald-800/60 mt-1">${sub}</div>` : ''}
        </div>
      `;
    }

    function renderKPIs(rows){
      const total = rows.length;
      const uniq = (arr, key) => new Set(arr.map(r => r[key]).filter(v => v !== null && v !== undefined && v !== '')).size;
      const uniqCampaigns = uniq(rows, 'campaignid');
      const uniqAdsets    = uniq(rows, 'adsetid');
      const orderedCount  = rows.filter(r => isTrue(r.ordered)).length;
      const orderedPct    = total ? Math.round((orderedCount/total)*100) : 0;

      const cards = [
        kpiCard({ label: 'Total Records', value: total.toLocaleString() }),
        kpiCard({ label: 'Unique Campaigns', value: uniqCampaigns.toLocaleString() }),
        kpiCard({ label: 'Unique Ad Sets', value: uniqAdsets.toLocaleString() }),
        kpiCard({ label: 'Ordered Ratio', value: `${orderedPct}%`, sub: `${orderedCount.toLocaleString()} TRUE` })
      ];

      if (messageFieldName){
        const metrics = aggregateByCampaign(rows);
        const totalMessages = metrics.reduce((acc, m) => acc + m.messages, 0);
        const totalOrders = metrics.reduce((acc, m) => acc + m.orders, 0);
        const ratio = totalMessages ? (totalOrders / totalMessages) : 0;
        const topMessage = metrics.filter(m => m.messages > 0).sort((a,b)=>b.messages - a.messages)[0];
        cards.push(
          kpiCard({ label: 'Total Messages', value: totalMessages.toLocaleString() }),
          kpiCard({ label: 'Orders per Message', value: ratio ? ratio.toFixed(2) : '0.00' })
        );
        if (topMessage){
          cards.push(
            kpiCard({ label: 'Most Messages', value: formatCampaignLabel(topMessage.campaignid), sub: `${Math.round(topMessage.messages).toLocaleString()} messages` })
          );
        }
      }

      kpisWrap.innerHTML = cards.join('');
    }

    function topCounts(rows, key, topN=15){
      const m = new Map();
      for (const r of rows){
        const k = r[key];
        if (k !== null && k !== undefined && k !== '') m.set(k, (m.get(k)||0)+1);
      }
      const arr = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0, topN);
      return { labels: arr.map(x=>String(x[0])), counts: arr.map(x=>x[1]) };
    }

    function ensureChart(ctx, type, data, options){
      if (ctx.__chart){ ctx.__chart.destroy(); }
      ctx.__chart = new Chart(ctx, { type, data, options });
      return ctx.__chart;
    }

    function renderCharts(rows){
      const cc = topCounts(rows, 'campaignid', 15);
      const cctx = document.getElementById('campaignChart');
      const campaignLabels = cc.labels.map(id => formatCampaignLabel(id));
      ensureChart(cctx, 'bar', {
        labels: campaignLabels,
        datasets: [{ label: 'Records', data: cc.counts, backgroundColor: '#16a34a' }]
      }, {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { title: (items) => items.map(item => campaignLabels[item.dataIndex]) } }
        },
        scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: true } }
      });

      const ordered = rows.filter(r => isTrue(r.ordered)).length;
      const notOrdered = rows.length - ordered;
      const octx = document.getElementById('orderedChart');
      ensureChart(octx, 'pie', { labels: ['Ordered (TRUE)', 'NULL'], datasets: [{ data: [ordered, notOrdered] }] }, { responsive: true });

      const ac = topCounts(rows, 'adsetid', 15);
      const actx = document.getElementById('adsetChart');
      ensureChart(actx, 'bar', {
        labels: ac.labels,
        datasets: [{ label: 'Records', data: ac.counts, backgroundColor: '#0ea5e9' }]
      }, {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { maxRotation: 0, autoSkip: true } }, y: { beginAtZero: true } }
      });

      const rctx = document.getElementById('ratioChart');
      const ratioEmpty = document.getElementById('ratioEmpty');
      if (messageFieldName && masterRows.length){
        const metrics = aggregateByCampaign(rows)
          .filter(m => m.messages > 0)
          .sort((a,b)=>b.messages - a.messages)
          .slice(0, 10);
        if (metrics.length){
          ratioEmpty.classList.add('hidden');
          rctx.classList.remove('hidden');
          const labels = metrics.map(m => formatCampaignLabel(m.campaignid));
          const data = metrics.map(m => Number.isFinite(m.orders / m.messages) ? Number((m.orders / m.messages).toFixed(3)) : 0);
          ratioChart = ensureChart(rctx, 'bar', {
            labels,
            datasets: [{ label: 'Orders per Message', data, backgroundColor: '#C6A044' }]
          }, {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ({ raw, dataIndex }) => `Ratio: ${raw}\n${metrics[dataIndex].orders.toLocaleString()} orders\n${Math.round(metrics[dataIndex].messages).toLocaleString()} messages`
                }
              }
            },
            scales: { y: { beginAtZero: true }, x: { ticks: { maxRotation: 0, autoSkip: true } } }
          });
        } else {
          if (ratioChart){ ratioChart.destroy(); ratioChart = null; }
          rctx.classList.add('hidden');
          ratioEmpty.classList.remove('hidden');
        }
      } else {
        if (ratioChart){ ratioChart.destroy(); ratioChart = null; }
        rctx.classList.add('hidden');
        ratioEmpty.classList.remove('hidden');
      }
    }

    function recordCard(r){
      const badge = (label) => `<span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-900">${label}</span>`;
      const hasOrdered = isTrue(r.ordered);
      return `
        <div class="rounded-2xl border border-emerald-100 bg-white p-4 shadow-soft">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-[11px] uppercase tracking-wide text-emerald-800/60">ID #${r.id}</div>
              <div class="mt-1 text-lg font-semibold text-emerald-900">Ad ${r.adid ?? '—'}</div>
            </div>
            <div class="h-9 w-9 rounded-xl flex items-center justify-center ${hasOrdered ? 'bg-brand-gold' : 'bg-emerald-100'}" title="Ordered">
              <svg data-lucide="${hasOrdered ? 'check' : 'circle'}" class="w-5 h-5 ${hasOrdered ? 'text-white' : 'text-emerald-700'}"></svg>
            </div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            ${badge('Campaign: ' + formatCampaignLabel(r.campaignid))}
            ${badge('Ad Set: ' + (r.adsetid ?? '—'))}
            ${r.psid != null ? badge('PSID: ' + r.psid) : ''}
          </div>
          ${hasOrdered ? `<div class="mt-3 text-sm text-emerald-900"><span class="font-semibold">Ordered:</span> TRUE</div>` : ''}
        </div>
      `;
    }

    function renderCards(rows){
      const start = pageIndex * PAGE_SIZE;
      const end   = start + PAGE_SIZE;
      const slice = rows.slice(start, end);
      const html = slice.map(recordCard).join('');
      if (pageIndex === 0) cardsWrap.innerHTML = html; else cardsWrap.insertAdjacentHTML('beforeend', html);
      loadMoreBtn.classList.toggle('hidden', end >= rows.length);
      lucide.createIcons();
    }

    function populateDropdowns(rows){
      const selectedCampaigns = getSelectedNumbers(fCampaign);
      const campaigns = Array.from(new Set(rows.map(r => r.campaignid).filter(v => v !== null && v !== undefined && v !== ''))).sort((a,b)=>a-b);
      fCampaign.innerHTML = campaigns.map(v => `<option value="${v}">${formatCampaignLabel(v)}</option>`).join('');
      setSelectedValues(fCampaign, selectedCampaigns.filter(v => campaigns.includes(v)));

      const campaignPool = selectedCampaigns.length ? rows.filter(r => selectedCampaigns.includes(r.campaignid)) : rows;
      const adsets = Array.from(new Set(campaignPool.map(r => r.adsetid).filter(v => v !== null && v !== undefined && v !== ''))).sort((a,b)=>a-b);
      const selectedAdsets = getSelectedNumbers(fAdset);
      fAdset.innerHTML = adsets.map(v => `<option value="${v}">${v}</option>`).join('');
      setSelectedValues(fAdset, selectedAdsets.filter(v => adsets.includes(v)));
    }

    async function ensureDirectory(){
      await loadCampaignDirectory();
      if (masterRows.length){
        messageFieldName = detectMessageField(masterRows);
      }
    }

    async function refreshMasterRows(){
      masterRows = await fetchAll(5000, { applyFilters: false });
      messageFieldName = detectMessageField(masterRows);
      populateDropdowns(masterRows);
    }

    async function run({ refreshDirectory=false } = {}){
      try {
        document.body.style.cursor = 'progress';
        if (!masterRows.length || refreshDirectory){
          await refreshMasterRows();
        } else {
          populateDropdowns(masterRows);
        }
        if (refreshDirectory) await loadCampaignDirectory(true);
        await ensureDirectory();
        populateDropdowns(masterRows);

        const rows = await fetchAll(5000, { applyFilters: true });
        filteredRows = rows;

        renderKPIs(filteredRows);
        renderCharts(filteredRows);
        paginatedRows = filteredRows;
        pageIndex = 0;
        renderCards(paginatedRows);
      } catch (err){
        console.error(err);
        alert('Failed to fetch data. Check Supabase RLS and credentials.\n' + (err.message || err));
      } finally {
        document.body.style.cursor = 'default';
      }
    }

    // Events
    refreshBtn.addEventListener('click', () => run({ refreshDirectory: true }));
    applyBtn.addEventListener('click', () => run());
    clearBtn.addEventListener('click', () => {
      clearMulti(fCampaign);
      clearMulti(fAdset);
      fOrdered.value = '';
      populateDropdowns(masterRows);
      run();
    });
    fCampaign.addEventListener('change', () => {
      populateDropdowns(masterRows);
      run();
    });
    fAdset.addEventListener('change', () => run());
    fOrdered.addEventListener('change', () => run());
    loadMoreBtn.addEventListener('click', () => {
      pageIndex += 1;
      renderCards(paginatedRows);
    });

    // Boot
    run();
  </script>
</body>
</html>
