<html lang="en" dir="ltr"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Campaigns Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&amp;display=swap" rel="stylesheet">
<style>

  :root{
    --bg:#0b0f0c;
    --panel:#0e1411;
    --panel-2:#0f1713;
    --card:#111b15;
    --ink:#e7f5ec;
    --muted:#adccb9;
    --accent:#29d27a;
    --accent-2:#22b86a;
    --accent-3:#8ef7c2;
    --ring: 0 0 0 2px rgba(41,210,122,.35), 0 10px 30px rgba(41,210,122,.15), inset 0 0 30px rgba(41,210,122,.05);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:
      radial-gradient(1000px 600px at 85% -20%, rgba(46,255,160,.12), transparent 55%),
      radial-gradient(900px 700px at -10% 110%, rgba(20,140,90,.25), transparent 60%),
      linear-gradient(180deg, #08100c, #0a120e 30%, #0b120e 100%);
    color:var(--ink);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  .shell{
    max-width:1100px;
    margin:0 auto;
    padding:28px clamp(16px,4vw,32px) 64px;
  }
  .hero{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    margin-bottom:28px;
  }
  .title{
    font-weight:800;
    letter-spacing:.2px;
    line-height:1.05;
    font-size: clamp(24px, 3vw, 34px);
    background: linear-gradient(120deg,#eafff3 0%, #b7ffdb 35%, #8ef7c2 60%, #eafff3 100%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 35px rgba(46,255,160,.1);
  }
  .subtitle{
    margin-top:6px;
    color:var(--muted);
    font-weight:400;
  }
  .panel{
    background:linear-gradient(180deg,rgba(255,255,255,.01),rgba(255,255,255,0)) , var(--panel);
    border:1px solid rgba(78,159,120,.18);
    border-radius:18px;
    box-shadow: var(--ring);
    overflow:hidden;
  }
  .panel header{
    padding:18px 20px;
    border-bottom:1px solid rgba(78,159,120,.18);
    background:linear-gradient(180deg, rgba(41,210,122,.08), transparent);
  }
  .panel header h2{
    margin:0;font-size:15px;font-weight:700;letter-spacing:.4px;color:#c6f3da;text-transform:uppercase;
  }
  .grid{
    display:grid;
    grid-template-columns: 1.15fr .85fr;
    gap:16px;
  }
  @media (max-width:980px){ .grid{grid-template-columns: 1fr;}}
  .block{padding:16px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.05)) , var(--card);
    border:1px solid rgba(78,159,120,.16);
    border-radius:14px;
    padding:14px;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:#c6e9d4;letter-spacing:.2px;font-weight:600;text-transform:uppercase}
  input, select, button{
    font:inherit;color:var(--ink);
    background:#0c1612;border:1px solid rgba(78,159,120,.25);
    border-radius:12px;padding:12px 14px;outline:none;
    transition:.2s ease;min-width:0;
  }
  input:focus,select:focus{box-shadow:0 0 0 2px rgba(41,210,122,.35)}
  .search{
    flex:1 1 260px;display:flex;gap:10px;align-items:center;
    background:#0c1612;border-radius:12px;border:1px solid rgba(78,159,120,.25);padding:8px 10px;
  }
  .search input{flex:1;border:none;background:transparent;padding:6px 8px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;text-decoration:none;
    cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent-2));
    color:#062412;border:none;font-weight:800;letter-spacing:.2px;
    padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(41,210,122,.25), inset 0 -1px 0 rgba(0,0,0,.2);
  }
  .btn.secondary{
    background:linear-gradient(180deg,#16261f,#111d17);
    color:#d6ffe9;border:1px solid rgba(78,159,120,.35);
  }
  .btn.ghost{
    background:transparent;border:1px dashed rgba(78,159,120,.35);color:#cfeede
  }
  .hero-actions{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:flex-end}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:640px){ .split{grid-template-columns:1fr}}
  .small{font-size:12px;color:var(--muted)}
  .stat{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px dashed rgba(78,159,120,.25);border-radius:12px;background:#0b1511}
  .count{font-weight:800;color:#b8ffd7}
  select{width:100%}
  .list{
    max-height:320px;overflow:auto;border:1px solid rgba(78,159,120,.2);border-radius:12px;background:#0b1511
  }
  .list option{padding:8px}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  #analysis{
    min-height:260px;white-space:pre-wrap;border-radius:14px;padding:16px;background:#0a1411;
    border:1px solid rgba(78,159,120,.2);line-height:1.45
  }
  .footer-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
  .status{padding:10px 12px;border-radius:10px;background:#0b1511;border:1px solid rgba(78,159,120,.25);color:#cde9db}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(41,210,122,.12);border:1px solid rgba(41,210,122,.35);color:#c9ffe2;font-size:12px;font-weight:700}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
  @media (max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
  .kpi .card{padding:12px}
  .kpi .card h3{margin:0 0 2px 0;font-size:12px;color:#c6e9d4;text-transform:uppercase;letter-spacing:.3px}
  .kpi .card div{font-weight:800;font-size:18px;color:#e8fff3}

</style>
<!--UIPATH_EXTENSION_ID: conkfbpnllelocpogdmbilgmnkabjfmf--></head>
<body>
  <div class="shell">
    <div class="hero">
      <div>
        <div class="title">Hey Mohamed, let's see how we can make your ads better.</div>
        <div class="subtitle">Live campaign directory with analysis on demand</div>
      </div>
      <div class="hero-actions">
        <div class="pill" id="statusPill">Ready</div>
        <a class="btn" href="/ADSDAMTONDA.html">Ads Damtonda</a>
      </div>
    </div>

    <section class="panel">
      <header><h2>Campaign Directory</h2></header>
      <div class="block">
        <div class="grid">
          <div class="card">
            <div class="row" style="margin-bottom:10px">
              <label>Search</label>
              <div class="search" style="width:100%">
                <input id="searchInput" type="text" placeholder="Filter by ID or nameâ€¦" autocomplete="off">
                <button class="btn secondary" id="loadBtn">Load Campaigns</button>
              </div>
            </div>
            <div class="split" style="margin-bottom:10px">
              <div class="stat"><span class="small">Loaded</span> <span class="count" id="loadedCount">58</span> <span class="small">campaigns</span></div>
              <div class="stat"><span class="small">Filtered</span> <span class="count" id="filteredCount">58</span></div>
            </div>
            <select id="campaignList" class="list" size="12"><option value="120200872447820134">120200872447820134 â€” Bestlife face</option><option value="120201121312910134">120201121312910134 â€” New messages campaign</option><option value="120201760433330264">120201760433330264 â€” Post: â€"â€#Ø¯Ø§Ù…ØªÙˆÙ†Ø¯Ø§ â€"â€</option><option value="120202096349800264">120202096349800264 â€” â€New messages campaign celery Ø³ÙŠÙ„ÙŠØ±ÙŠâ€ â€“ Copy</option><option value="120203421466510652">120203421466510652 â€” New Engagement Campaign</option><option value="120203872501860620">120203872501860620 â€” New messages campaign</option><option value="120203961121960426">120203961121960426 â€” Damtonda</option><option value="120205101347840264">120205101347840264 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="120205112813140032">120205112813140032 â€” New messages campaign</option><option value="120205400644000032">120205400644000032 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option><option value="120205933860940652">120205933860940652 â€” Ù…Ù†Ø´ÙˆØ± Instagram: â€#Ø³ÙŠÙ„ÙŠØ±Ù‰_Ø§Ù„Ø´Ø¯ÙŠØ¯_Ø±Ø¬Ø¹_Ù…Ù†_Ø¬Ø¯ÙŠØ¯#...</option><option value="120205933864770652">120205933864770652 â€” Ù…Ù†Ø´ÙˆØ± Instagram: â€#Ø³ÙŠÙ„ÙŠØ±Ù‰_Ø§Ù„Ø´Ø¯ÙŠØ¯_Ø±Ø¬Ø¹_Ù…Ù†_Ø¬Ø¯ÙŠØ¯#...</option><option value="120206169780790652">120206169780790652 â€” Ù…Ù†Ø´ÙˆØ± Instagram: â€#Ø¯Ø§Ù…ØªÙˆÙ†Ø¯Ø§_Ø§Ø®ØªÙŠØ§Ø±_Ø§Ù„Ù†Ø¬ÙˆÙ… Ø±Ø§Ù‰...</option><option value="120206404225690652">120206404225690652 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="120206559675960264">120206559675960264 â€” â€Ø³ÙŠÙ„ÙŠØ±Ù‰â€ â€“ Copy</option><option value="120206941969420205">120206941969420205 â€” Bestlife_eg</option><option value="120207574349060443">120207574349060443 â€” Damtonda pharma</option><option value="120208733981150264">120208733981150264 â€” New messages campaign â€“ Copy</option><option value="120209589629110311">120209589629110311 â€” [03/11/2024] Promoting Bestlifeeg_</option><option value="120209865153000264">120209865153000264 â€” New messages campaign â€“ Copy</option><option value="120211642915900620">120211642915900620 â€” Damtonda pha5</option><option value="120211734026840443">120211734026840443 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="120211857813720032">120211857813720032 â€” Damtonda official</option><option value="120212280479330609">120212280479330609 â€” Post: â€"â€ğŸ  Ø¹Ø±Ø¶ Ù…Ø­Ø¯ÙˆØ¯! ğŸ â€"â€</option><option value="120215307519530169">120215307519530169 â€” â€Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„â€ â€“ Copy</option><option value="120215465111260155">120215465111260155 â€” Bestlife_eg â€“ Copy</option><option value="120217023569650011">120217023569650011 â€” New Engagement Campaign â€“ Copy</option><option value="120219580882350311">120219580882350311 â€” New Engagement Campaign â€“ Copy</option><option value="120224182978380205">120224182978380205 â€” New Engagement Campaign â€“ Copy</option><option value="120225101522530205">120225101522530205 â€” New Engagement Campaign â€“ Copy</option><option value="120225120224650205">120225120224650205 â€” New Engagement Campaign â€“ Copy</option><option value="120226924855190426">120226924855190426 â€” â€Ø¬Ø°Ø¨ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø®ØµØµØ© Ù„Ù„Ø­Ù…Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©â€ â€Ù Ù¡/Ù Ù§/Ù¢Ù Ù¢Ù¥â€ â€Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©â€</option><option value="120227027208530620">120227027208530620 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="120227428469370529">120227428469370529 â€” Damtonda</option><option value="120227818865540529">120227818865540529 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="120228971549820264">120228971549820264 â€” Lipofit official</option><option value="120229097165990264">120229097165990264 â€” New Engagement Campaign</option><option value="120230303478820205">120230303478820205 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="120230385756840205">120230385756840205 â€” â€â€â€Ù…Ù†Ø´ÙˆØ± Instagram: â€ğŸ›‘ Ø§ÙˆØ¹ÙŠ ØªØ³ØªØ®Ø¯Ù…ÙŠ Lipo Fit! Ø¥Ù„Ø§ Ù„Ùˆ...â€ â€“ Copyâ€ â€“ Copyâ€ â€“ Copy</option><option value="120230706616570205">120230706616570205 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option><option value="120230828956290155">120230828956290155 â€” Instagram post: â€#Ù„ÙŠØ¨ÙˆÙÙŠØª# Ø´ÙƒØ±Ø§Ø§ Ø¬Ø¯Ø§ Ù„Ø±Ø§ÙŠ Ø­Ø¶Ø±ØªÙƒ...</option><option value="120231102152700279">120231102152700279 â€” New Engagement Campaign â€“ Copy</option><option value="120231647263390032">120231647263390032 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="120231695724050032">120231695724050032 â€” New Engagement Campaign</option><option value="120232093982540279">120232093982540279 â€” New messages campaign</option><option value="120232260036110169">120232260036110169 â€” New Engagement Campaign</option><option value="23851627693110168">23851627693110168 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="23857530736980168">23857530736980168 â€” New Engagement campaign â€“ Copy</option><option value="23857666723630651">23857666723630651 â€” Bestlifeeg</option><option value="23858066666850528">23858066666850528 â€” : â€"â€#Damtonda_Ø¯Ø§Ù…ØªÙˆÙ†Ø¯Ø§# â€"â€</option><option value="23858318573990651">23858318573990651 â€” Bestlifeeg</option><option value="23858999791060013">23858999791060013 â€” â€â€Celery_Zorilâ€â€â€</option><option value="23859275282500010">23859275282500010 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„ Ø³ÙŠÙ„ÙŠØ±ÙŠ celery</option><option value="23861370128300013">23861370128300013 â€” Sa7itk2</option><option value="23862456845650013">23862456845650013 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‡Ø¯Ù Ø§Ù„ØªÙØ§Ø¹Ù„</option><option value="6272649589939">6272649589939 â€” ØµØ­ØªÙƒ Ù…Ø³Ø¦ÙˆÙ„ÙŠØªÙƒ â€“ Message replies</option><option value="6272663337139">6272663337139 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</option><option value="6272664659139">6272664659139 â€” Ø­Ù…Ù„Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</option></select>
            <div class="split" style="margin-top:10px">
              <div>
                <label>Manual Campaign ID</label>
                <input id="manualId" type="text" placeholder="Paste a Campaign ID" class="mono">
              </div>
              <div>
                <label>Selected Campaign</label>
                <input id="selectedId" type="text" class="mono" readonly="">
              </div>
            </div>

            <!-- New: Date Preset dropdown -->
            <div style="margin-top:10px">
              <label>Date Preset</label>
              <select id="datePreset">
                <option value="today">today</option>
                <option value="yesterday">yesterday</option>
                <option value="this_month">this_month</option>
                <option value="last_month">last_month</option>
                <option value="this_quarter">this_quarter</option>
                <option value="maximum">maximum</option>
                <option value="data_maximum">data_maximum</option>
                <option value="last_3d">last_3d</option>
                <option value="last_7d" selected="">last_7d</option>
                <option value="last_14d">last_14d</option>
                <option value="last_28d">last_28d</option>
                <option value="last_30d">last_30d</option>
                <option value="last_90d">last_90d</option>
                <option value="last_week_mon_sun">last_week_mon_sun</option>
                <option value="last_week_sun_sat">last_week_sun_sat</option>
                <option value="last_quarter">last_quarter</option>
                <option value="last_year">last_year</option>
                <option value="this_week_mon_today">this_week_mon_today</option>
                <option value="this_week_sun_today">this_week_sun_today</option>
                <option value="this_year">this_year</option>
              </select>
            </div>
            <!-- End new block -->

            <div class="actions" style="margin-top:12px">
              <button class="btn" id="analyzeBtn">Analyze</button>
              <button class="btn ghost" id="copyIdBtn">Copy ID</button>
              <button class="btn ghost" id="downloadBtn">Download HTML</button>
            </div>
          </div>

          <div class="card">
            <div class="kpi">
              <div class="card"><h3>Directory</h3><div id="kpiDir">58 loaded</div></div>
              <div class="card"><h3>Platform</h3><div id="kpiPlat">Meta</div></div>
              <div class="card"><h3>Mode</h3><div id="kpiMode">Listing + Analysis</div></div>
              <div class="card"><h3>Status</h3><div id="kpiStatus">Ready</div></div>
            </div>
            <div style="margin-top:14px">
              <label>Analysis Output</label>
              <div id="analysis" class="mono"></div>
              <div class="footer-actions">
                <button class="btn secondary" id="copyAnalysisBtn">Copy Analysis</button>
                <button class="btn ghost" id="clearAnalysisBtn">Clear</button>
              </div>
            </div>
            <div style="margin-top:10px" class="small" id="debugArea"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  const LIST_URL = 'https://primary-production-9e01d.up.railway.app/webhook/88011745-0650-4fdc-9caa-628ed08eab95';
  const ANALYSIS_URL = 'https://primary-production-9e01d.up.railway.app/webhook/d7b7b663-e181-46b1-9b11-3dafe594db8e';

  const statusPill = document.getElementById('statusPill');
  const kpiDir = document.getElementById('kpiDir');
  const kpiStatus = document.getElementById('kpiStatus');
  const loadedCount = document.getElementById('loadedCount');
  const filteredCount = document.getElementById('filteredCount');
  const searchInput = document.getElementById('searchInput');
  const list = document.getElementById('campaignList');
  const selectedId = document.getElementById('selectedId');
  const manualId = document.getElementById('manualId');
  const analysisBox = document.getElementById('analysis');
  const debugArea = document.getElementById('debugArea');
  const loadBtn = document.getElementById('loadBtn');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const copyIdBtn = document.getElementById('copyIdBtn');
  const copyAnalysisBtn = document.getElementById('copyAnalysisBtn');
  const clearAnalysisBtn = document.getElementById('clearAnalysisBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  /* New: capture date preset element */
  const datePreset = document.getElementById('datePreset');

  let campaignsRaw = [];
  let campaignsParsed = [];
  let filtered = [];

  function setStatus(text){
    statusPill.textContent = text;
    kpiStatus.textContent = text;
  }

  function setDirectoryKpi(n){
    kpiDir.textContent = n > 0 ? `${n} loaded` : 'â€“';
  }

  function parseCampaignLine(line){
    if (typeof line !== 'string') return null;
    const clean = line.replace(/\r/g,'').trim();
    const idx = clean.indexOf(' - ');
    if (idx === -1) {
      const idOnly = clean.trim();
      return { id: idOnly, name: '' };
    }
    const id = clean.slice(0, idx).trim();
    const name = clean.slice(idx + 3).replace(/\s+/g,' ').trim();
    return { id, name };
  }

  function normalizeListingPayload(data){
    try{
      if (!data) return [];
      const root = Array.isArray(data) ? data[0] : data;
      if (!root) return [];
      const arr = root['all campaigns'] || root['all_campaigns'] || root['campaigns'] || [];
      if (!Array.isArray(arr)) return [];
      const unique = new Map();
      for (const item of arr){
        const parsed = parseCampaignLine(item);
        if (parsed && parsed.id){
          unique.set(parsed.id, parsed);
        }
      }
      return Array.from(unique.values());
    }catch(e){
      return [];
    }
  }

  async function fetchJson(url, options={}){
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 300000);
    try{
      const res = await fetch(url, {mode:'cors', credentials:'omit', cache:'no-store', signal:controller.signal, ...options});
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = text; }
      return { ok: res.ok, status: res.status, data: json, raw: text };
    }catch(err){
      return { ok:false, status:0, data:null, raw:String(err && err.message || err) };
    }finally{
      clearTimeout(t);
    }
  }

  function renderList(items){
    list.innerHTML = '';
    for (const c of items){
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = `${c.id} â€” ${c.name || ''}`.trim();
      list.appendChild(o);
    }
    filtered = items;
    filteredCount.textContent = String(items.length);
  }

  function applyFilter(){
    const q = searchInput.value.trim().toLowerCase();
    if (!q){
      renderList(campaignsParsed);
      return;
    }
    const out = campaignsParsed.filter(c =>
      c.id.toLowerCase().includes(q) || (c.name||'').toLowerCase().includes(q)
    );
    renderList(out);
  }

  async function loadCampaigns(){
    setStatus('Loading campaigns');
    debugArea.textContent = '';
    const res = await fetchJson(LIST_URL, { method:'GET' });
    if (!res.ok){
      setStatus('List failed');
      debugArea.textContent = `Listing error [${res.status}]: ${res.raw}`;
      campaignsParsed = [];
      loadedCount.textContent = '0';
      filteredCount.textContent = '0';
      renderList([]);
      setDirectoryKpi(0);
      return;
    }
    let payload = res.data;
    if (typeof payload === 'string'){
      try{ payload = JSON.parse(payload); }catch{}
    }
    campaignsRaw = payload;
    campaignsParsed = normalizeListingPayload(payload);
    loadedCount.textContent = String(campaignsParsed.length);
    setDirectoryKpi(campaignsParsed.length);
    renderList(campaignsParsed);
    setStatus('Ready');
  }

  list.addEventListener('change', ()=>{
    const val = list.value || '';
    selectedId.value = val;
  });

  searchInput.addEventListener('input', ()=>{
    window.clearTimeout(searchInput._t);
    searchInput._t = setTimeout(applyFilter, 120);
  });

  loadBtn.addEventListener('click', loadCampaigns);

  copyIdBtn.addEventListener('click', async ()=>{
    const id = selectedId.value || manualId.value || '';
    if (!id){ setStatus('No ID'); return; }
    try{
      await navigator.clipboard.writeText(id);
      setStatus('ID copied');
    }catch{
      setStatus('Copy failed');
    }
  });

  clearAnalysisBtn.addEventListener('click', ()=>{
    analysisBox.textContent = '';
    debugArea.textContent = '';
    setStatus('Cleared');
  });

  copyAnalysisBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(analysisBox.textContent || '');
      setStatus('Analysis copied');
    }catch{
      setStatus('Copy failed');
    }
  });

  downloadBtn.addEventListener('click', ()=>{
    const blob = new Blob([document.documentElement.outerHTML], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'campaigns_analysis_tool.html';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus('Downloaded');
  });

  async function analyze(campaignId){
    if (!campaignId) { setStatus('No ID'); return; }
    setStatus('Analyzing');
    debugArea.textContent = '';
    analysisBox.textContent = '';

    const tryPost = await fetchJson(ANALYSIS_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ campaign_id: campaignId, ["date preset"]: (datePreset ? datePreset.value : "") })
    });

    let result = tryPost;
    if (!tryPost.ok){
      const url = ANALYSIS_URL + '?campaign_id=' + encodeURIComponent(campaignId) + '&' + encodeURIComponent('date preset') + '=' + encodeURIComponent(datePreset ? datePreset.value : '');
      const tryGet = await fetchJson(url, { method:'GET' });
      result = tryGet;
    }

    if (!result.ok){
      analysisBox.textContent = '';
      debugArea.textContent = `Analysis error [${result.status}]: ${result.raw}`;
      setStatus('Analysis failed');
      return;
    }

    let payload = result.data;
    if (typeof payload === 'string'){
      try{ payload = JSON.parse(payload); }catch{/*keep string*/}
    }

    let analysisText = '';
    if (payload && typeof payload === 'object' && !Array.isArray(payload) && 'analysis' in payload){
      analysisText = String(payload.analysis ?? '').trim();
    } else if (Array.isArray(payload) && payload.length && typeof payload[0] === 'object' && 'analysis' in payload[0]) {
      analysisText = String(payload[0].analysis ?? '').trim();
    } else if (typeof payload === 'string'){
      analysisText = payload.trim();
    } else {
      analysisText = JSON.stringify(payload, null, 2);
    }

    analysisBox.textContent = analysisText || '';
    setStatus('Done');
  }

  analyzeBtn.addEventListener('click', ()=>{
    const id = (selectedId.value || '').trim() || (manualId.value || '').trim();
    analyze(id);
  });

  loadCampaigns();
})();
</script>


</body></html>
